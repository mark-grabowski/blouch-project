---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r}
rm(list=ls())
library(devtools)
#devtools::install_github("Mark-Grabowski/blouch")

#library(blouch)
#load_all()
# Load necessary packages
library(ape)
library(slouch)
library(rstan)
library(treeplyr)
library(ggplot2)
library(ggsci)
library(bridgesampling)

#For execution on a local, multicore CPU with excess RAM we recommend calling
options(mc.cores = parallel::detectCores())
#options(mc.cores = 8)
rstan_options(auto_write = TRUE)
```

For the purposes of illustrating the software, we will use a dataset of ruminant brain and body sizes bundled with the Slouch package (Kopperud et al. 2020) and a corresponding phylogenetic tree (ToljagiÄ‡ et al. 2017). First, we will organize the brain and body data.
```{r load data}
## Load the phylogenetic tree with annotation data
data(artiodactyla)
phy <- artiodactyla

## Load the neocortex dataset
data(neocortex)

## Plot the tree
plot(ladderize(phy), cex = 0.6)
```

Stealing some code from the Slouch tutorial, regimes are shown painted on the phylogeny as below
```{r}
## Inspect the internal node regimes
## These have order n+1, n+2, n+3 ...
internal_regimes <- factor(phy$node.label)

## Concatenate tip and internal regimes. These will have order 1,2,3 ...
regimes <- c(neocortex$diet, internal_regimes)

## Pick out the regimes of the edges, in the order of phy$edge
edge_regimes <- factor(regimes[phy$edge[,2]])

plot(phy, 
     edge.color = c("Black", "Orange", "blue")[edge_regimes], 
     edge.width = 3, cex = 0.6)
```


Next we will use the treeplyr function make.treedata to combine the data and tree based on the "species" column, which has the taxa names. See https://github.com/uyedaj/treeplyr for more on this package.Then we will filter the data so only individuals with both brain and body size, as well as the variance in brain and body size are included. Variance in these traits is considered measurement error, estimation error in species averages. Finally we mean scale the X data (here body mass) so that the average across species is 0.

```{r}
ruminant.trdata <- make.treedata(phy, neocortex,name_column="species")

ruminant.trdata<-filter(ruminant.trdata,!(is.na(brain_mass_g_log_mean)) & !(is.na(body_mass_g_log_mean)) &!(is.na(neocortex_area_mm2_log_mean)))
ruminant.trdata<-filter(ruminant.trdata,!(is.na(brain_se_squared)) & !(is.na(body_se_squared)) & !(is.na(neocortex_se_squared)))

ruminant.trdata<-mutate(ruminant.trdata,me.neocortex = neocortex_se_squared/n_neocortex)
ruminant.trdata<-mutate(ruminant.trdata,me.brain = brain_se_squared/n_brain)
ruminant.trdata<-mutate(ruminant.trdata,me.body = body_se_squared/n_body)
#ruminant.trdata #Full dataset

#Mean Scale Predictors
ruminant.trdata$dat$bodycentered<-ruminant.trdata$dat$body_mass_g_log_mean-mean(ruminant.trdata$dat$body_mass_g_log_mean)
ruminant.trdata$dat$braincentered<-ruminant.trdata$dat$brain_mass_g_log_mean-mean(ruminant.trdata$dat$brain_mass_g_log_mean)

```

## Rescale Tree
Next, we rescale Tree to Height = 1
```{r}
l.tree<-max(branching.times(ruminant.trdata$phy))
ruminant.trdata$phy$edge.length<-ruminant.trdata$phy$edge.length/l.tree ## rescale tree to height 1
max(branching.times(ruminant.trdata$phy))

```

##############

###################################
Single Covariates - No Fixed Regimes
```{r}
#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/R Setup Code/R1/blouchOU.setup.mv_v1_2.R") #To use with blouchOU_v1_6.stan

#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/R Setup Code/R1/blouchOU.setup.mv_v1_3.R") #To use with blouchOU_c1_7.stan

source("/Users/markgrabowski/Library/CloudStorage/GoogleDrive-mark.walter.grabowski@gmail.com/Other computers/My MacBook Pro (1)/Academic/Research/Current Projects/Blouch project/R1/Code/R Setup Code/R1/blouchOU.setup.mv_v1_3.R")

#Direct and Random model - 1 trait each
name.response.trait<-c("neocortex_area_mm2_log_mean")
name.response.me.trait<-c("me.neocortex")
names.random.traits<-c("braincentered")
names.random.me.traits<-c("me.brain")
names.direct.traits<-c("bodycentered")
names.direct.me.traits<-c("me.body")


#Data must be logged before entry into blouchOU.setup
###############################
#One random covariate, w ME
stan_data<-blouchOU.setup.mv(ruminant.trdata,name.response.trait,names.direct.traits=NULL,names.random.traits,name.response.me.trait,names.direct.me.traits=NULL,names.random.me.traits)

#One random covariate, no ME
stan_data<-blouchOU.setup.mv(ruminant.trdata,name.response.trait,names.direct.traits=NULL,names.random.traits)

#####################
#One direct covariate w ME
stan_data<-blouchOU.setup.mv(ruminant.trdata,name.response.trait,names.direct.traits,names.random.traits=NULL,name.response.me.trait,names.direct.me.traits,names.random.me.traits=NULL)

#One direct covariate wo ME
stan_data<-blouchOU.setup.mv(ruminant.trdata,name.response.trait,names.direct.traits,names.random.traits=NULL)

```


Two Random and Two Direct Covariates - No Fixed Regimes
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/R Setup Code/R1/blouchOU.setup.mv_v1_2.R")

#Two covariates
###############
name.response.trait<-c("neocortex_area_mm2_log_mean")
names.random.traits<-c("braincentered","bodycentered")
names.direct.traits<-c("braincentered","bodycentered")
name.response.me.trait<-c("me.neocortex")
names.direct.me.traits<-c("me.brain","me.body")
names.random.me.traits<-c("me.brain","me.body")

################
#Two random covariates only w ME
stan_data<-blouchOU.setup.mv(ruminant.trdata,name.response.trait,names.direct.traits=NULL,names.random.traits,name.response.me.trait,names.direct.me.traits=NULL,names.random.me.traits)

#Two Random covariates only no ME
stan_data<-blouchOU.setup.mv(ruminant.trdata,name.response.trait,names.direct.traits=NULL,names.random.traits)
   

#Two direct covariates only w/ME
stan_data<-blouchOU.setup.mv(ruminant.trdata,name.response.trait,names.direct.traits,names.random.traits=NULL,name.response.me.trait,names.direct.me.traits,names.random.me.traits=NULL)

#Two direct covariates only w/o ME
stan_data<-blouchOU.setup.mv(ruminant.trdata,name.response.trait,names.direct.traits,names.random.traits=NULL)
                          
```

One Direct and One Random Covariate - No Fixed Regimes
```{r}
#########################

#Direct and Random model - 1 trait each
name.response.trait<-c("neocortex_area_mm2_log_mean")
name.response.me.trait<-c("me.neocortex")
names.random.traits<-c("braincentered")
names.random.me.traits<-c("me.brain")
names.direct.traits<-c("bodycentered")
names.direct.me.traits<-c("me.body")

#Random and Direct covariates w ME
stan_data<-blouchOU.setup.mv(ruminant.trdata,name.response.trait,names.direct.traits,names.random.traits,name.response.me.trait,names.direct.me.traits,names.random.me.traits)

#Random and Direct covariates wo/ ME
stan_data<-blouchOU.setup.mv(ruminant.trdata,name.response.trait,names.direct.traits,names.random.traits)


```

Run Model
```{r}
stan_data<-stan_data[[1]]

```

Trend Model
```{r}
#setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1")
setwd("/Users/markgrabowski/Library/CloudStorage/GoogleDrive-mark.walter.grabowski@gmail.com/Other computers/My MacBook Pro (1)/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1/")

stanc("/Users/markgrabowski/Library/CloudStorage/GoogleDrive-mark.walter.grabowski@gmail.com/Other computers/My MacBook Pro (1)/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1/blouchBM_v1_2.stan")

stan_model <- stan_model("blouchBM_v1_2.stan")

fit<- rstan::sampling(object = stan_model,data = stan_data,chains = 1,iter = 2000,control=list(adapt_delta=0.975))

#BM model
print(fit,pars = c("beta","sigma2_y","r_squared"))


```


Random Model - One trait w/ ME
```{r}
slouch.OU<-slouch.fit(phy = ruminant.trdata$phy,
                              species = ruminant.trdata$phy$tip.label,
                              response = ruminant.trdata$dat$neocortex_area_mm2_log_mean,
                              random.cov = ruminant.trdata$dat$braincentered,
                              mv.random.cov = ruminant.trdata$dat$me.brain,

                              hl_values = seq(0.00001, 0.25, length.out = 50),
                              vy_values = seq(0.00001, 0.2, length.out = 50),
                              hillclimb = TRUE,convergence = 150,
                              lower = c(0.00001, 0.00001)

                       )
summary(slouch.OU)
```

Trend Model - One trait w/ ME
```{r}
slouch.BM<-brown.fit(phy = ruminant.trdata$phy,
                              species = ruminant.trdata$phy$tip.label,
                              response = ruminant.trdata$dat$neocortex_area_mm2_log_mean,
                              random.cov = ruminant.trdata$dat$braincentered,
                              mv.random.cov = ruminant.trdata$dat$me.brain,
                              hillclimb = TRUE,convergence = 150,
                              lower = c(0.00001, 0.00001)

                       )
summary(slouch.BM)
```


