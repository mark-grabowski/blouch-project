---
title: "Blouch SBR1 - Artiodactyl Testing using Fixed Regimes"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r}
rm(list=ls())
library(devtools)
#devtools::install_github("Mark-Grabowski/blouch")

#library(blouch)
#load_all()
# Load necessary packages
library(ape)
library(slouch)
library(rstan)
library(treeplyr)
library(ggplot2)
library(ggsci)
library(bridgesampling)

#For execution on a local, multicore CPU with excess RAM we recommend calling
options(mc.cores = parallel::detectCores())
#options(mc.cores = 8)
rstan_options(auto_write = TRUE)

dotR <- file.path(Sys.getenv("HOME"), ".R")
if (!file.exists(dotR)) dir.create(dotR)
M <- file.path(dotR, "Makevars")
if (!file.exists(M)) file.create(M)
arch <- ifelse(R.version$arch == "aarch64", "arm64", "x86_64")
cat(paste("\nCXX14FLAGS += -O3 -mtune=native -arch", arch, "-ftemplate-depth-256"),
    file = M, sep = "\n", append = FALSE)

```


For the purposes of illustrating the software, we will use a dataset of ruminant brain and body sizes bundled with the Slouch package (Kopperud et al. 2020) and a corresponding phylogenetic tree (Toljagić et al. 2017). First, we will organize the brain and body data.
```{r load data}
## Load the phylogenetic tree with annotation data
data(artiodactyla)
phy <- artiodactyla

## Load the neocortex dataset
data(neocortex)

## Plot the tree
plot(ladderize(phy), cex = 0.6)
```

Stealing some code from the Slouch tutorial, regimes are shown painted on the phylogeny as below
```{r}
## Inspect the internal node regimes
## These have order n+1, n+2, n+3 ...
internal_regimes <- factor(phy$node.label)

## Concatenate tip and internal regimes. These will have order 1,2,3 ...
regimes <- c(neocortex$diet, internal_regimes)

## Pick out the regimes of the edges, in the order of phy$edge
edge_regimes <- factor(regimes[phy$edge[,2]])

plot(phy, 
     edge.color = c("Black", "Orange", "blue")[edge_regimes], 
     edge.width = 3, cex = 0.6)
```


Next we will use the treeplyr function make.treedata to combine the data and tree based on the "species" column, which has the taxa names. See https://github.com/uyedaj/treeplyr for more on this package.Then we will filter the data so only individuals with both brain and body size, as well as the variance in brain and body size are included. Variance in these traits is considered measurement error, estimation error in species averages. Finally we mean scale the X data (here body mass) so that the average across species is 0.

```{r}
ruminant.trdata <- make.treedata(phy, neocortex,name_column="species")

ruminant.trdata<-filter(ruminant.trdata,!(is.na(brain_mass_g_log_mean)) & !(is.na(body_mass_g_log_mean)) &!(is.na(neocortex_area_mm2_log_mean)))
ruminant.trdata<-filter(ruminant.trdata,!(is.na(brain_se_squared)) & !(is.na(body_se_squared)) & !(is.na(neocortex_se_squared)))

ruminant.trdata<-mutate(ruminant.trdata,me.neocortex = neocortex_se_squared/n_neocortex)
ruminant.trdata<-mutate(ruminant.trdata,me.brain = brain_se_squared/n_brain)
ruminant.trdata<-mutate(ruminant.trdata,me.body = body_se_squared/n_body)
#ruminant.trdata #Full dataset

#Mean Scale Predictors
ruminant.trdata$dat$bodycentered<-ruminant.trdata$dat$body_mass_g_log_mean-mean(ruminant.trdata$dat$body_mass_g_log_mean)
ruminant.trdata$dat$braincentered<-ruminant.trdata$dat$brain_mass_g_log_mean-mean(ruminant.trdata$dat$brain_mass_g_log_mean)

```

## Rescale Tree
Next, we rescale Tree to Height = 1
```{r}
l.tree<-max(branching.times(ruminant.trdata$phy))
ruminant.trdata$phy$edge.length<-ruminant.trdata$phy$edge.length/l.tree ## rescale tree to height 1
max(branching.times(ruminant.trdata$phy))

```

Set regimes - manually - 2 regimes
```{r}
#shifts<-identifyBranches(phy,2)$sb
plot(phy)
tiplabels()
nodelabels()
#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/set.regimes.R")

source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/set.converge.regimes.R")
#shifts<-list(c(72,66),c(56))
#shifts<-list(88,78)
shifts<-c(78) #Location of nodes with regime shifts
ruminant.trdata<-set.converge.regimes(ruminant.trdata,shifts)

#ruminant.trdata<-set.regimes(ruminant.trdata,shifts)

```

Check if manual setting code worked
```{r}
shifts.total<-c(ruminant.trdata$dat$regimes,ruminant.trdata$phy$node.label)
  edge.regimes <- factor(shifts.total[ruminant.trdata$phy$edge[,2]])
  print(edge.regimes)
  #Get ggplot colors used for plot to make on tree
  gg_color_hue <- function(n) {
    hues = seq(15, 375, length=n+1)
    hcl(h=hues, l=65, c=100)[1:n]
  }
  
  reg.colors<-gg_color_hue(length(unique(ruminant.trdata$dat$regimes)))

  print(reg.colors)
  plot(ruminant.trdata$phy,edge.color = reg.colors[edge.regimes], edge.width = 1, cex = 0.2)
  

```



```{r}
#Direct and Random model - 1 trait each
#name.response.trait<-c("neocortex_area_mm2_log_mean")
#name.response.me.trait<-c("me.neocortex")
#names.random.traits<-c("braincentered")
names.direct.traits<-c("bodycentered")
names.direct.me.traits<-c("me.body")
#names.random.me.traits<-c("me.brain")
names.fixed.fact<-c("regimes")

```



Simulate Y variable for Single Covariates - fixed Regimes/direct effect model
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/blouch_simOUReg.setup.test.R")

optima<-c(4,6,0.8)

#One random covariate w ME
#stan_data<-blouchsimOUReg.setup.test(ruminant.trdata,names.fixed.fact,names.direct.traits=NULL,names.random.traits,names.direct.me.traits=NULL,names.random.me.traits,hl=0.1,vy=0.01,beta=c(4,5,6,0.8))

#One direct covariate w/o ME
stan_sim_data<-blouchsimOUReg.setup.test(ruminant.trdata,names.fixed.fact,names.direct.traits,names.random.traits=NULL,names.direct.me.traits=NULL,names.random.me.traits=NULL,hl=0.1,vy=0.01,beta=optima)


```


Simulate data
```{r}
setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/")
stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/simRegimes.stan")

stan_model <- stan_model("simRegimes.stan")

fit.simdata<- rstan::sampling(object = stan_model,data = stan_sim_data,chains = 2,iter = 4000,control=list(adapt_delta=0.95),algorithm=c("Fixed_param"))

#For downstream analysis and plots
ext.fit.simdata <- rstan::extract(fit.simdata)

```


Add simulated code to dataset
```{r}
#Extract simulated brain mass data
brain_mass_g_log_mean.sim<-as.data.frame(ext.fit.simdata$Y_pred)

#names(brain_mass_g_log_mean.sim)<-paste(names(brain_mass_g_log_mean.sim)

test<-data.frame(t(brain_mass_g_log_mean.sim[1:100,]))
names(test)<-paste("Sim",1:100,sep="")

#Add to original dataset
ruminant.trdata$dat<-cbind(ruminant.trdata$dat,test)
```


Inaccuracy loops for simulated repeated optima
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/repeated_optima_sim.R")

names.traits<-c("bodycentered","me.body","regimes")
error.comparison.2reg<-repeated_optima_sim(ruminant.trdata,n=10,names.traits,head(optima,-1))
error.comparison.2reg
```


For the purposes of illustrating the software, we will use a dataset of ruminant brain and body sizes bundled with the Slouch package (Kopperud et al. 2020) and a corresponding phylogenetic tree (Toljagić et al. 2017). First, we will organize the brain and body data.
```{r load data}
## Load the phylogenetic tree with annotation data
data(artiodactyla)
phy <- artiodactyla

## Load the neocortex dataset
data(neocortex)

## Plot the tree
plot(ladderize(phy), cex = 0.6)
```

Stealing some code from the Slouch tutorial, regimes are shown painted on the phylogeny as below
```{r}
## Inspect the internal node regimes
## These have order n+1, n+2, n+3 ...
internal_regimes <- factor(phy$node.label)

## Concatenate tip and internal regimes. These will have order 1,2,3 ...
regimes <- c(neocortex$diet, internal_regimes)

## Pick out the regimes of the edges, in the order of phy$edge
edge_regimes <- factor(regimes[phy$edge[,2]])

plot(phy, 
     edge.color = c("Black", "Orange", "blue")[edge_regimes], 
     edge.width = 3, cex = 0.6)
```


Next we will use the treeplyr function make.treedata to combine the data and tree based on the "species" column, which has the taxa names. See https://github.com/uyedaj/treeplyr for more on this package.Then we will filter the data so only individuals with both brain and body size, as well as the variance in brain and body size are included. Variance in these traits is considered measurement error, estimation error in species averages. Finally we mean scale the X data (here body mass) so that the average across species is 0.

```{r}
ruminant.trdata <- make.treedata(phy, neocortex,name_column="species")

ruminant.trdata<-filter(ruminant.trdata,!(is.na(brain_mass_g_log_mean)) & !(is.na(body_mass_g_log_mean)) &!(is.na(neocortex_area_mm2_log_mean)))
ruminant.trdata<-filter(ruminant.trdata,!(is.na(brain_se_squared)) & !(is.na(body_se_squared)) & !(is.na(neocortex_se_squared)))

ruminant.trdata<-mutate(ruminant.trdata,me.neocortex = neocortex_se_squared/n_neocortex)
ruminant.trdata<-mutate(ruminant.trdata,me.brain = brain_se_squared/n_brain)
ruminant.trdata<-mutate(ruminant.trdata,me.body = body_se_squared/n_body)
#ruminant.trdata #Full dataset

#Mean Scale Predictors
ruminant.trdata$dat$bodycentered<-ruminant.trdata$dat$body_mass_g_log_mean-mean(ruminant.trdata$dat$body_mass_g_log_mean)
ruminant.trdata$dat$braincentered<-ruminant.trdata$dat$brain_mass_g_log_mean-mean(ruminant.trdata$dat$brain_mass_g_log_mean)

```

## Rescale Tree
Next, we rescale Tree to Height = 1
```{r}
l.tree<-max(branching.times(ruminant.trdata$phy))
ruminant.trdata$phy$edge.length<-ruminant.trdata$phy$edge.length/l.tree ## rescale tree to height 1
max(branching.times(ruminant.trdata$phy))

```

Set regimes - manually - 3 regimes
```{r}
#shifts<-identifyBranches(phy,2)$sb
plot(phy)
tiplabels()
nodelabels()
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/set.regimes.R")
shifts<-c(78,51) #Location of nodes with regime shifts
ruminant.trdata<-set.regimes(ruminant.trdata,shifts)

```

Check if manual setting code worked
```{r}
shifts.total<-c(ruminant.trdata$dat$regimes,ruminant.trdata$phy$node.label)
  edge.regimes <- factor(shifts.total[ruminant.trdata$phy$edge[,2]])
  print(edge.regimes)
  #Get ggplot colors used for plot to make on tree
  gg_color_hue <- function(n) {
    hues = seq(15, 375, length=n+1)
    hcl(h=hues, l=65, c=100)[1:n]
  }
  
  reg.colors<-gg_color_hue(length(unique(ruminant.trdata$dat$regimes)))

  print(reg.colors)
  plot(ruminant.trdata$phy,edge.color = reg.colors[edge.regimes], edge.width = 1, cex = 0.2)
  

```


```{r}
#Direct and Random model - 1 trait each
#name.response.trait<-c("neocortex_area_mm2_log_mean")
#name.response.me.trait<-c("me.neocortex")
#names.random.traits<-c("braincentered")
names.direct.traits<-c("bodycentered")
names.direct.me.traits<-c("me.body")
#names.random.me.traits<-c("me.brain")
names.fixed.fact<-c("regimes")

```


Simulate Y variable for Single Covariates - fixed Regimes/direct effect model
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/blouch_simOUReg.setup.test.R")

optima<-c(4,5,6,0.8)

#One random covariate w ME
#stan_data<-blouchsimOUReg.setup.test(ruminant.trdata,names.fixed.fact,names.direct.traits=NULL,names.random.traits,names.direct.me.traits=NULL,names.random.me.traits,hl=0.1,vy=0.01,beta=c(4,5,6,0.8))

#One direct covariate w/o ME
stan_sim_data<-blouchsimOUReg.setup.test(ruminant.trdata,names.fixed.fact,names.direct.traits,names.random.traits=NULL,names.direct.me.traits=NULL,names.random.me.traits=NULL,hl=0.1,vy=0.01,beta=optima)


```


Simulate data
```{r}
setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/")
stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/simRegimes.stan")

stan_model <- stan_model("simRegimes.stan")

fit.simdata<- rstan::sampling(object = stan_model,data = stan_sim_data,chains = 2,iter = 4000,control=list(adapt_delta=0.95),algorithm=c("Fixed_param"))

#For downstream analysis and plots
ext.fit.simdata <- rstan::extract(fit.simdata)

```



```{r}
#Extract simulated brain mass data
brain_mass_g_log_mean.sim<-as.data.frame(ext.fit.simdata$Y_pred)

#names(brain_mass_g_log_mean.sim)<-paste(names(brain_mass_g_log_mean.sim)

test<-data.frame(t(brain_mass_g_log_mean.sim[1:100,]))
names(test)<-paste("Sim",1:100,sep="")

#Add to original dataset
ruminant.trdata$dat<-cbind(ruminant.trdata$dat,test)
```



Inaccuracy loops for simulated repeated optima
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/repeated_optima_sim.R")

names.traits<-c("bodycentered","me.body","regimes")
error.comparison.3reg<-repeated_optima_sim(ruminant.trdata,n=10,names.traits,head(optima,-1))
error.comparison.3reg
```



#######################
4 Regimes
For the purposes of illustrating the software, we will use a dataset of ruminant brain and body sizes bundled with the Slouch package (Kopperud et al. 2020) and a corresponding phylogenetic tree (Toljagić et al. 2017). First, we will organize the brain and body data.
```{r load data}
## Load the phylogenetic tree with annotation data
data(artiodactyla)
phy <- artiodactyla

## Load the neocortex dataset
data(neocortex)

```



Next we will use the treeplyr function make.treedata to combine the data and tree based on the "species" column, which has the taxa names. See https://github.com/uyedaj/treeplyr for more on this package.Then we will filter the data so only individuals with both brain and body size, as well as the variance in brain and body size are included. Variance in these traits is considered measurement error, estimation error in species averages. Finally we mean scale the X data (here body mass) so that the average across species is 0.

```{r}
ruminant.trdata <- make.treedata(phy, neocortex,name_column="species")

ruminant.trdata<-filter(ruminant.trdata,!(is.na(brain_mass_g_log_mean)) & !(is.na(body_mass_g_log_mean)) &!(is.na(neocortex_area_mm2_log_mean)))
ruminant.trdata<-filter(ruminant.trdata,!(is.na(brain_se_squared)) & !(is.na(body_se_squared)) & !(is.na(neocortex_se_squared)))

ruminant.trdata<-mutate(ruminant.trdata,me.neocortex = neocortex_se_squared/n_neocortex)
ruminant.trdata<-mutate(ruminant.trdata,me.brain = brain_se_squared/n_brain)
ruminant.trdata<-mutate(ruminant.trdata,me.body = body_se_squared/n_body)
#ruminant.trdata #Full dataset

#Mean Scale Predictors
ruminant.trdata$dat$bodycentered<-ruminant.trdata$dat$body_mass_g_log_mean-mean(ruminant.trdata$dat$body_mass_g_log_mean)
ruminant.trdata$dat$braincentered<-ruminant.trdata$dat$brain_mass_g_log_mean-mean(ruminant.trdata$dat$brain_mass_g_log_mean)

```

## Rescale Tree
Next, we rescale Tree to Height = 1
```{r}
l.tree<-max(branching.times(ruminant.trdata$phy))
ruminant.trdata$phy$edge.length<-ruminant.trdata$phy$edge.length/l.tree ## rescale tree to height 1
max(branching.times(ruminant.trdata$phy))

```


Set regimes - manually
```{r}
#shifts<-identifyBranches(phy,2)$sb
quartz()
plot(phy)
tiplabels()
nodelabels()
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/set.regimes.R")
shifts<-c(85,78,63) #Location of nodes with regime shifts
ruminant.trdata<-set.regimes(ruminant.trdata,shifts)

```

Check if manual setting code worked
```{r}
shifts.total<-c(ruminant.trdata$dat$regimes,ruminant.trdata$phy$node.label)
  edge.regimes <- factor(shifts.total[ruminant.trdata$phy$edge[,2]])
  print(edge.regimes)
  #Get ggplot colors used for plot to make on tree
  gg_color_hue <- function(n) {
    hues = seq(15, 375, length=n+1)
    hcl(h=hues, l=65, c=100)[1:n]
  }
  
  reg.colors<-gg_color_hue(length(unique(ruminant.trdata$dat$regimes)))

  print(reg.colors)
  plot(ruminant.trdata$phy,edge.color = reg.colors[edge.regimes], edge.width = 1, cex = 0.2)
  #plot(ruminant.trdata$phy)

```


```{r}
#Direct and Random model - 1 trait each
#name.response.trait<-c("neocortex_area_mm2_log_mean")
#name.response.me.trait<-c("me.neocortex")
#names.random.traits<-c("braincentered")
names.direct.traits<-c("bodycentered")
names.direct.me.traits<-c("me.body")
#names.random.me.traits<-c("me.brain")
names.fixed.fact<-c("regimes")

```


Simulate Y variable for Single Covariates - fixed Regimes/direct effect model
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/blouch_simOUReg.setup.test.R")

optima<-c(4,5,6,7,0.8)

#One random covariate w ME
#stan_data<-blouchsimOUReg.setup.test(ruminant.trdata,names.fixed.fact,names.direct.traits=NULL,names.random.traits,names.direct.me.traits=NULL,names.random.me.traits,hl=0.1,vy=0.01,beta=c(4,5,6,0.8))

#One direct covariate w/o ME
stan_sim_data<-blouchsimOUReg.setup.test(ruminant.trdata,names.fixed.fact,names.direct.traits,names.random.traits=NULL,names.direct.me.traits=NULL,names.random.me.traits=NULL,hl=0.1,vy=0.01,beta=optima)


```


Simulate data
```{r}
setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/")
stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/simRegimes.stan")

stan_model <- stan_model("simRegimes.stan")

fit.simdata<- rstan::sampling(object = stan_model,data = stan_sim_data,chains = 2,iter = 4000,control=list(adapt_delta=0.95),algorithm=c("Fixed_param"))

#For downstream analysis and plots
ext.fit.simdata <- rstan::extract(fit.simdata)

```



```{r}
#Extract simulated brain mass data
brain_mass_g_log_mean.sim<-as.data.frame(ext.fit.simdata$Y_pred)

#names(brain_mass_g_log_mean.sim)<-paste(names(brain_mass_g_log_mean.sim)

test<-data.frame(t(brain_mass_g_log_mean.sim[1:100,]))
names(test)<-paste("Sim",1:100,sep="")

#Add to original dataset
ruminant.trdata$dat<-cbind(ruminant.trdata$dat,test)
```


Inaccuracy loops for simulated repeated optima
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/repeated_optima_sim.R")

names.traits<-c("bodycentered","me.body","regimes")
error.comparison.4reg<-repeated_optima_sim(ruminant.trdata,n=10,names.traits,head(optima,-1))
error.comparison.4reg
```


Plot Regimes
```{r}
errors.combined<-data.frame(t(cbind(error.comparison.2reg[[3]],error.comparison.3reg[[3]],error.comparison.4reg[[3]])))
errors.combined<-cbind(errors.combined,reps=1:30,regimes=c(rep(2,10),rep(3,10),rep(4,10)))
regimes<-c(2,3,4)
mean.errors.combined<-data.frame(errors.combined%>%group_by(regimes)%>%mutate(mlm.mean=mean(mlm.inaccuracy),npm.mean=mean(npm.inaccuracy)))

mean.errors.combined%>%group_by(regimes)%>%
#errors.combined%>%
  ggplot(aes(x=reps,group=regimes))+
  geom_point(aes(y=mlm.inaccuracy),size=2.0,alpha=0.8)+
  geom_point(aes(y=npm.inaccuracy),shape=21,size=2.0,alpha=0.8)+
  geom_line(aes(x=reps,y=mlm.mean),linetype="solid")+
  geom_line(aes(x=reps,y=npm.mean),linetype="dashed")+
  geom_vline(xintercept=c(10.5,20.5),alpha=0.75,linetype="dotted")+
  ylab("Imprecision") + xlab("Regimes")+
  theme_bw()+
  scale_color_npg()+
  #theme(legend.text)
  scale_x_continuous(breaks=c(5,15,25),labels=regimes)
  #geom_label(label=c(""))


  


```





######
End


#######################
4 Regimes
For the purposes of illustrating the software, we will use a dataset of ruminant brain and body sizes bundled with the Slouch package (Kopperud et al. 2020) and a corresponding phylogenetic tree (Toljagić et al. 2017). First, we will organize the brain and body data.
```{r load data}
## Load the phylogenetic tree with annotation data
data(artiodactyla)
phy <- artiodactyla

## Load the neocortex dataset
data(neocortex)

```



Next we will use the treeplyr function make.treedata to combine the data and tree based on the "species" column, which has the taxa names. See https://github.com/uyedaj/treeplyr for more on this package.Then we will filter the data so only individuals with both brain and body size, as well as the variance in brain and body size are included. Variance in these traits is considered measurement error, estimation error in species averages. Finally we mean scale the X data (here body mass) so that the average across species is 0.

```{r}
ruminant.trdata <- make.treedata(phy, neocortex,name_column="species")

ruminant.trdata<-filter(ruminant.trdata,!(is.na(brain_mass_g_log_mean)) & !(is.na(body_mass_g_log_mean)) &!(is.na(neocortex_area_mm2_log_mean)))
ruminant.trdata<-filter(ruminant.trdata,!(is.na(brain_se_squared)) & !(is.na(body_se_squared)) & !(is.na(neocortex_se_squared)))

ruminant.trdata<-mutate(ruminant.trdata,me.neocortex = neocortex_se_squared/n_neocortex)
ruminant.trdata<-mutate(ruminant.trdata,me.brain = brain_se_squared/n_brain)
ruminant.trdata<-mutate(ruminant.trdata,me.body = body_se_squared/n_body)
#ruminant.trdata #Full dataset

#Mean Scale Predictors
ruminant.trdata$dat$bodycentered<-ruminant.trdata$dat$body_mass_g_log_mean-mean(ruminant.trdata$dat$body_mass_g_log_mean)
ruminant.trdata$dat$braincentered<-ruminant.trdata$dat$brain_mass_g_log_mean-mean(ruminant.trdata$dat$brain_mass_g_log_mean)

```

## Rescale Tree
Next, we rescale Tree to Height = 1
```{r}
l.tree<-max(branching.times(ruminant.trdata$phy))
ruminant.trdata$phy$edge.length<-ruminant.trdata$phy$edge.length/l.tree ## rescale tree to height 1
max(branching.times(ruminant.trdata$phy))

```


Set regimes - manually
```{r}
#shifts<-identifyBranches(phy,2)$sb
quartz()
plot(phy)
tiplabels()
nodelabels()
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/set.regimes.R")
shifts<-c(85,78,63) #Location of nodes with regime shifts
ruminant.trdata<-set.regimes(ruminant.trdata,shifts)

```

Check if manual setting code worked
```{r}
shifts.total<-c(ruminant.trdata$dat$regimes,ruminant.trdata$phy$node.label)
  edge.regimes <- factor(shifts.total[ruminant.trdata$phy$edge[,2]])
  print(edge.regimes)
  #Get ggplot colors used for plot to make on tree
  gg_color_hue <- function(n) {
    hues = seq(15, 375, length=n+1)
    hcl(h=hues, l=65, c=100)[1:n]
  }
  
  reg.colors<-gg_color_hue(length(unique(ruminant.trdata$dat$regimes)))

  print(reg.colors)
  plot(ruminant.trdata$phy,edge.color = reg.colors[edge.regimes], edge.width = 1, cex = 0.2)
  #plot(ruminant.trdata$phy)

```


```{r}
#Direct and Random model - 1 trait each
#name.response.trait<-c("neocortex_area_mm2_log_mean")
#name.response.me.trait<-c("me.neocortex")
#names.random.traits<-c("braincentered")
names.direct.traits<-c("bodycentered")
names.direct.me.traits<-c("me.body")
#names.random.me.traits<-c("me.brain")
names.fixed.fact<-c("regimes")

```


Simulate Y variable for Single Covariates - fixed Regimes/direct effect model
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/blouch_simOUReg.setup.test.R")

optima<-c(4,5,6,7,0.8)

#One random covariate w ME
#stan_data<-blouchsimOUReg.setup.test(ruminant.trdata,names.fixed.fact,names.direct.traits=NULL,names.random.traits,names.direct.me.traits=NULL,names.random.me.traits,hl=0.1,vy=0.01,beta=c(4,5,6,0.8))

#One direct covariate w/o ME
stan_sim_data<-blouchsimOUReg.setup.test(ruminant.trdata,names.fixed.fact,names.direct.traits,names.random.traits=NULL,names.direct.me.traits=NULL,names.random.me.traits=NULL,hl=0.1,vy=0.01,beta=optima)


```


Simulate data
```{r}
setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/")
stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/simRegimes.stan")

stan_model <- stan_model("simRegimes.stan")

fit.simdata<- rstan::sampling(object = stan_model,data = stan_sim_data,chains = 2,iter = 4000,control=list(adapt_delta=0.95),algorithm=c("Fixed_param"))

#For downstream analysis and plots
ext.fit.simdata <- rstan::extract(fit.simdata)

```



```{r}
#Extract simulated brain mass data
brain_mass_g_log_mean.sim<-as.data.frame(ext.fit.simdata$Y_pred)

#names(brain_mass_g_log_mean.sim)<-paste(names(brain_mass_g_log_mean.sim)

test<-data.frame(t(brain_mass_g_log_mean.sim[1:100,]))
names(test)<-paste("Sim",1:100,sep="")

#Add to original dataset
ruminant.trdata$dat<-cbind(ruminant.trdata$dat,test)
```




Setup for running singly Blouch to test for recovery of true values - fixed Regimes/direct effect model
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/R Setup Code/R1/blouchOUReg.setup.mv_v1_3.R")

#Mean center and make new columns
#Sim1.data<-ruminant.trdata$dat$Sim1
#Sim1.mean<-mean(Sim1.data)
#Sim1.data.mc<-Sim1.data-mean(Sim1.data)
#ruminant.trdata$dat<-cbind(ruminant.trdata$dat,"Sim.MC1"=Sim1.data.mc)

#name.response.trait<-"Sim.MC1" #For Mean Centered Y
name.response.trait<-"Sim1" #For normal Y
names.direct.traits<-c("bodycentered")
names.direct.me.traits<-c("me.body")
names.fixed.fact<-c("regimes")

#One random covariate w/o ME
#stan_data<-blouchOUReg.setup.mv(ruminant.trdata,names.fixed.fact,name.response.trait,names.direct.traits,names.random.traits=NULL)

#One direct covariate w/o ME
stan_test_data<-blouchOUReg.setup.mv(ruminant.trdata,names.fixed.fact,name.response.trait,names.direct.traits,names.random.traits=NULL)


```



##################################
Stan Fit - Original Blouch
```{r}

setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1")
stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1/blouchOUReg_v1_5.stan")

stan_model <- stan_model("blouchOUReg_v1_5.stan")

fit.org<- rstan::sampling(object = stan_model,data = stan_test_data,chains = 2,iter = 2000,control=list(adapt_delta=0.95))

print(fit.org,pars = c("a","hl","beta","beta_e","vy","r_squared","sigma2_y"))
  
#For downstream analysis and plots
extract.fit.org <- rstan::extract(fit.org)

mu.post.beta<-apply(extract.fit.org$beta[,1:length(optima)],2,median)
npg.error<-abs(apply(extract.fit.org$beta[,1:length(optima)],2,median)-optima)
npg.inaccuracy<-mean((mu.post.beta-optima)^2)

#Mean centered Y
#mu.post.beta<-apply(extract.fit.org$beta[,1:length(optima)],2,median)+Sim1.mean
#npg.error<-abs(mu.post.beta[1:length(optima)-1]-head(optima,-1))
#npg.inaccuracy<-mean((mu.post.beta[1:length(optima)-1]-head(optima,-1))^2)


```

Stan Fit - Multilevel Blouch
```{r}
setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1")
#stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1/blouchOUReg_test.stan")
stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1/blouchOUReg_opt_test.stan")

#stan_model <- stan_model("blouchOUReg_test.stan")
stan_model <- stan_model("blouchOUReg_opt_test.stan")

fit.ml<- rstan::sampling(object = stan_model,data = stan_test_data,chains = 1,iter = 2000,control=list(adapt_delta=0.95))

#print(fit.ml,pars = c("a","hl","beta_raw","beta","beta_bar","sd_beta","beta_e","vy","r_squared","sigma2_y"))
print(fit.ml,pars = c("a","hl","beta","beta_bar","sd_beta","beta_e","vy","r_squared","sigma2_y"))

  
#For downstream analysis and plots
extract.fit.mlm <- rstan::extract(fit.ml)

mu.post.beta<-apply(extract.fit.mlm$beta[,1:length(optima)],2,median)
mlm.error<-abs(apply(extract.fit.mlm$beta[,1:length(optima)],2,median)-optima)
mlm.inaccuracy<-mean((mu.post.beta-optima)^2)

#Mean centered Y
#mu.post.beta<-apply(extract.fit.mlm$beta[,1:length(optima)-1],2,median)+Sim1.mean
#mlm.error<-abs(mu.post.beta-head(optima,-1))
#mlm.inaccuracy<-mean((mu.post.beta-head(optima,-1))^2)



```

```{r}
pairs(fit.ml,pars=c("hl","beta","vy"))
```


```{r}
library(dplyr)
library(ggplot2)
library(ggsci)
sim.data<-data.frame("Species"=ruminant.trdata$phy$tip.label,ruminant.trdata$dat)
org.beta.mean<-apply(extract.fit.org$beta,2,mean)
ml.beta.mean<-apply(extract.fit.ml$beta,2,mean)
org.beta.error<-abs(org.beta.mean-stan_sim_data$beta)
ml.beta.error<-abs(ml.beta.mean-stan_sim_data$beta)


```


Simulated Species grouped by regimes compared to true regimes
```{r}
regime.color<-pal_npg("nrc",alpha=0.7)(5)

ruminant.trdata%>%
ggplot(aes(x=bodycentered,y=Sim1,color=regime))+
  geom_point()+
  geom_hline(yintercept=c(4,5,6,7,8),color=regime.color)+
  #geom_hline(yintercept=org.beta.mean[-4])+
  #geom_hline(yintercept=ml.beta.mean[-4])+
  scale_color_npg()

```


Inaccuracy loops for simulated repeated optima
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/repeated_optima_sim.R")

names.traits<-c("bodycentered","me.body","regimes")
error.comparison.4reg<-repeated_optima_sim(ruminant.trdata,n=10,names.traits,head(optima,-1))
error.comparison.4reg
```

```{r}
errors.combined<-data.frame(t(cbind(error.comparison.3reg[[3]],error.comparison.4reg[[3]])))
errors.combined%>%
  ggplot(aes(x=1:20,y=mlm.inaccuracy),color=1)+
  geom_point(size=2.0,alpha=0.8)+
  geom_point(aes(y=npm.inaccuracy),color=2,size=2.0,alpha=0.8)+
  geom_hline(aes(yintercept=mean(mlm.inaccuracy)))+
  geom_vline(aes(xintercept=10),alpha=0.2)+

  geom_hline(aes(yintercept=mean(npm.inaccuracy)),color=2)+
  ylab("Imprecision") + xlab("Replications")+
  theme_bw()+
  scale_color_npg()
  #scale_x_discrete(breaks=c(1:10,1:10))

  


```

Single runs for 10K Tree Sims below
####################



Setup for running singly Blouch to test for recovery of true values - fixed Regimes/direct effect model
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/R Setup Code/R1/blouchOUReg.setup.mv_v1_3.R")

#Mean center and make new columns
#Sim1.data<-ruminant.trdata$dat$Sim1
#Sim1.mean<-mean(Sim1.data)
#Sim1.data.mc<-Sim1.data-mean(Sim1.data)
#ruminant.trdata$dat<-cbind(ruminant.trdata$dat,"Sim.MC1"=Sim1.data.mc)

#name.response.trait<-"Sim.MC1" #For Mean Centered Y
name.response.trait<-"Sim1" #For normal Y
names.direct.traits<-c("X")
names.direct.me.traits<-c("NA")
names.fixed.fact<-c("regimes")

#One random covariate w/o ME
#stan_data<-blouchOUReg.setup.mv(ruminant.trdata,names.fixed.fact,name.response.trait,names.direct.traits,names.random.traits=NULL)

#One direct covariate w/o ME
stan_test_data<-blouchOUReg.setup.mv(reg.trdata,names.fixed.fact,name.response.trait,names.direct.traits,names.random.traits=NULL)


```



##################################
Stan Fit - Original Blouch
```{r}

setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1")
stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1/blouchOUReg_v1_5.stan")

stan_model <- stan_model("blouchOUReg_v1_5.stan")

fit.org<- rstan::sampling(object = stan_model,data = stan_test_data,chains = 2,iter = 2000,control=list(adapt_delta=0.95))

print(fit.org,pars = c("a","hl","beta","beta_e","vy","r_squared","sigma2_y"))
  
#For downstream analysis and plots
extract.fit.org <- rstan::extract(fit.org)

mu.post.beta<-apply(extract.fit.org$beta[,1:length(optima)],2,median)
npg.error<-abs(apply(extract.fit.org$beta[,1:length(optima)],2,median)-optima)
npg.inaccuracy<-mean((mu.post.beta-optima)^2)

#Mean centered Y
#mu.post.beta<-apply(extract.fit.org$beta[,1:length(optima)],2,median)+Sim1.mean
#npg.error<-abs(mu.post.beta[1:length(optima)-1]-head(optima,-1))
#npg.inaccuracy<-mean((mu.post.beta[1:length(optima)-1]-head(optima,-1))^2)


```

Stan Fit - Multilevel Blouch
```{r}
setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1")
#stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1/blouchOUReg_test.stan")
stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Code/Stan Code/R1/blouchOUReg_opt_test.stan")

#stan_model <- stan_model("blouchOUReg_test.stan")
stan_model <- stan_model("blouchOUReg_opt_test.stan")

fit.ml<- rstan::sampling(object = stan_model,data = stan_test_data,chains = 1,iter = 2000,control=list(adapt_delta=0.95))

#print(fit.ml,pars = c("a","hl","beta_raw","beta","beta_bar","sd_beta","beta_e","vy","r_squared","sigma2_y"))
print(fit.ml,pars = c("a","hl","beta","beta_bar","sd_beta","beta_e","vy","r_squared","sigma2_y"))

  
#For downstream analysis and plots
extract.fit.mlm <- rstan::extract(fit.ml)

mu.post.beta<-apply(extract.fit.mlm$beta[,1:length(optima)],2,median)
mlm.error<-abs(apply(extract.fit.mlm$beta[,1:length(optima)],2,median)-optima)
mlm.inaccuracy<-mean((mu.post.beta-optima)^2)

#Mean centered Y
#mu.post.beta<-apply(extract.fit.mlm$beta[,1:length(optima)-1],2,median)+Sim1.mean
#mlm.error<-abs(mu.post.beta-head(optima,-1))
#mlm.inaccuracy<-mean((mu.post.beta-head(optima,-1))^2)



```





###################
Simulations using 10K Tree - 50 tips
```{r}
library(phytools)
set.seed(1)
tree.10K<-read.tree("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/Original Submission/Blouch Testing/Phylogeny/10KPrimateTree.tre")
saved.tips<-50
sampled.tree.10K <- keep.tip(tree.10K,sample(tree.10K$tip.label)[1:saved.tips]) 

l.tree<-max(branching.times(sampled.tree.10K))
sampled.tree.10K$edge.length<-sampled.tree.10K$edge.length/l.tree ## rescale tree to height 1

x.var<-fastBM(sampled.tree.10K)
species.data<-data.frame(species=names(x.var),X=x.var)
trdata <- make.treedata(sampled.tree.10K, species.data,name_column="species")


```

Set regimes - manually - 3 regimes, includes convergence
```{r}
#shifts<-identifyBranches(phy,2)$sb
quartz()
plot(trdata$phy)
tiplabels(cex=0.5,frame="none")
nodelabels(cex=0.5,frame="none")
#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/set.regimes.R")
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/set.converge.regimes.R")
#shifts<-list(c(72,66),c(56))
shifts<-list(88,78)
reg.trdata<-set.converge.regimes(trdata,shifts)

```

Check if manual setting code worked
```{r}
shifts.total<-c(reg.trdata$dat$regimes,reg.trdata$phy$node.label)
  edge.regimes <- factor(shifts.total[reg.trdata$phy$edge[,2]])
  print(edge.regimes)
  #Get ggplot colors used for plot to make on tree
  gg_color_hue <- function(n) {
    hues = seq(15, 375, length=n+1)
    hcl(h=hues, l=65, c=100)[1:n]
  }
  
  reg.colors<-gg_color_hue(length(unique(reg.trdata$dat$regimes)))

  print(reg.colors)
  plot(reg.trdata$phy,edge.color = reg.colors[edge.regimes], edge.width = 1, cex = 0.2)
  

```



```{r}
#Direct and Random model - 1 trait each
#name.response.trait<-c("neocortex_area_mm2_log_mean")
#name.response.me.trait<-c("me.neocortex")
#names.random.traits<-c("braincentered")
names.direct.traits<-c("X")
#names.random.me.traits<-c("me.brain")
names.fixed.fact<-c("regimes")

```



Simulate Y variable for Single Covariates - fixed Regimes/direct effect model
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/blouch_simOUReg.setup.test.R")

optima<-c(4,4.25,4.5,0.8)

#One random covariate w ME
#stan_data<-blouchsimOUReg.setup.test(ruminant.trdata,names.fixed.fact,names.direct.traits=NULL,names.random.traits,names.direct.me.traits=NULL,names.random.me.traits,hl=0.1,vy=0.01,beta=c(4,5,6,0.8))

#One direct covariate w/o ME
stan_sim_data<-blouchsimOUReg.setup.test(reg.trdata,names.fixed.fact,names.direct.traits,names.random.traits=NULL,names.direct.me.traits=NULL,names.random.me.traits=NULL,hl=0.1,vy=0.01,beta=optima)


```


Simulate data
```{r}
setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/")
stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/simRegimes.stan")

stan_model <- stan_model("simRegimes.stan")

fit.simdata<- rstan::sampling(object = stan_model,data = stan_sim_data,chains = 2,iter = 4000,control=list(adapt_delta=0.95),algorithm=c("Fixed_param"))

#For downstream analysis and plots
ext.fit.simdata <- rstan::extract(fit.simdata)

```



```{r}
#Extract simulated brain mass data
Y_pred<-as.data.frame(ext.fit.simdata$Y_pred)

#names(brain_mass_g_log_mean.sim)<-paste(names(brain_mass_g_log_mean.sim)

test<-data.frame(t(Y_pred[1:100,]))
names(test)<-paste("Sim",1:100,sep="")

#Add to original dataset
reg.trdata$dat<-cbind(reg.trdata$dat,test)
```


Inaccuracy loops for simulated repeated optima
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/repeated_optima_sim.R")

names.traits<-c("X",NA,"regimes")
error.comparison.3reg<-repeated_optima_sim(reg.trdata,n=10,names.traits,head(optima,-1))
error.comparison.3reg
```


Set regimes - manually - 5 regimes, includes convergence
```{r}
#shifts<-identifyBranches(phy,2)$sb
quartz()
plot(trdata$phy)
tiplabels(cex=0.5,frame="none")
nodelabels(cex=0.5,frame="none")
#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/set.regimes.R")
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/set.converge.regimes.R")
#shifts<-list(c(97,87),73,55,63)
shifts<-list(88,78,73,66)
reg.trdata<-set.converge.regimes(trdata,shifts)

```

Check if manual setting code worked
```{r}
shifts.total<-c(reg.trdata$dat$regimes,reg.trdata$phy$node.label)
  edge.regimes <- factor(shifts.total[reg.trdata$phy$edge[,2]])
  print(edge.regimes)
  #Get ggplot colors used for plot to make on tree
  gg_color_hue <- function(n) {
    hues = seq(15, 375, length=n+1)
    hcl(h=hues, l=65, c=100)[1:n]
  }
  
  reg.colors<-gg_color_hue(length(unique(reg.trdata$dat$regimes)))

  print(reg.colors)
  plot(reg.trdata$phy,edge.color = reg.colors[edge.regimes], edge.width = 1, cex = 0.2)
  

```

```{r}
#Direct and Random model - 1 trait each
#name.response.trait<-c("neocortex_area_mm2_log_mean")
#name.response.me.trait<-c("me.neocortex")
#names.random.traits<-c("braincentered")
names.direct.traits<-c("X")
#names.random.me.traits<-c("me.brain")
names.fixed.fact<-c("regimes")

```

Simulate Y variable for Single Covariates - fixed Regimes/direct effect model
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/blouch_simOUReg.setup.test.R")

optima<-c(4,4.25,4.5,4.75,5,0.8)

#One random covariate w ME
#stan_data<-blouchsimOUReg.setup.test(ruminant.trdata,names.fixed.fact,names.direct.traits=NULL,names.random.traits,names.direct.me.traits=NULL,names.random.me.traits,hl=0.1,vy=0.01,beta=c(4,5,6,0.8))

#One direct covariate w/o ME
stan_sim_data<-blouchsimOUReg.setup.test(reg.trdata,names.fixed.fact,names.direct.traits,names.random.traits=NULL,names.direct.me.traits=NULL,names.random.me.traits=NULL,hl=0.1,vy=0.01,beta=optima)


```

Simulate data
```{r}
setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/")
stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/simRegimes.stan")

stan_model <- stan_model("simRegimes.stan")

fit.simdata<- rstan::sampling(object = stan_model,data = stan_sim_data,chains = 2,iter = 4000,control=list(adapt_delta=0.95),algorithm=c("Fixed_param"))

#For downstream analysis and plots
ext.fit.simdata <- rstan::extract(fit.simdata)

```

```{r}
#Extract simulated brain mass data
Y_pred<-as.data.frame(ext.fit.simdata$Y_pred)

#names(brain_mass_g_log_mean.sim)<-paste(names(brain_mass_g_log_mean.sim)

test<-data.frame(t(Y_pred[1:100,]))
names(test)<-paste("Sim",1:100,sep="")

#Add to original dataset
reg.trdata$dat<-cbind(reg.trdata$dat,test)
```

Inaccuracy loops for simulated repeated optima
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/repeated_optima_sim.R")

names.traits<-c("X",NA,"regimes")
error.comparison.5reg<-repeated_optima_sim(reg.trdata,n=10,names.traits,head(optima,-1))
error.comparison.5reg
```

Set regimes - manually - 7 regimes, includes convergence
```{r}
#shifts<-identifyBranches(phy,2)$sb
#quartz()
plot(trdata$phy)
tiplabels(cex=0.5,frame="none")
nodelabels(cex=0.5,frame="none")
#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/set.regimes.R")
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/set.converge.regimes.R")
shifts<-list(88,89,78,73,66,56)
reg.trdata<-set.converge.regimes(trdata,shifts)

```

Check if manual setting code worked
```{r}
shifts.total<-c(reg.trdata$dat$regimes,reg.trdata$phy$node.label)
  edge.regimes <- factor(shifts.total[reg.trdata$phy$edge[,2]])
  print(edge.regimes)
  #Get ggplot colors used for plot to make on tree
  gg_color_hue <- function(n) {
    hues = seq(15, 375, length=n+1)
    hcl(h=hues, l=65, c=100)[1:n]
  }
  
  reg.colors<-gg_color_hue(length(unique(reg.trdata$dat$regimes)))

  print(reg.colors)
  plot(reg.trdata$phy,edge.color = reg.colors[edge.regimes], edge.width = 1, cex = 0.2)
  

```

```{r}
#Direct and Random model - 1 trait each
#name.response.trait<-c("neocortex_area_mm2_log_mean")
#name.response.me.trait<-c("me.neocortex")
#names.random.traits<-c("braincentered")
names.direct.traits<-c("X")
#names.random.me.traits<-c("me.brain")
names.fixed.fact<-c("regimes")

```

Simulate Y variable for Single Covariates - fixed Regimes/direct effect model
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/blouch_simOUReg.setup.test.R")

optima<-c(4,4.25,4.5,4.75,5,5.25,5.5,0.8)

#One random covariate w ME
#stan_data<-blouchsimOUReg.setup.test(ruminant.trdata,names.fixed.fact,names.direct.traits=NULL,names.random.traits,names.direct.me.traits=NULL,names.random.me.traits,hl=0.1,vy=0.01,beta=c(4,5,6,0.8))

#One direct covariate w/o ME
stan_sim_data<-blouchsimOUReg.setup.test(reg.trdata,names.fixed.fact,names.direct.traits,names.random.traits=NULL,names.direct.me.traits=NULL,names.random.me.traits=NULL,hl=0.1,vy=0.01,beta=optima)


```

Simulate data
```{r}
setwd("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/")
stanc("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/SBR1 Simulate Regimes Code/simRegimes.stan")

stan_model <- stan_model("simRegimes.stan")

fit.simdata<- rstan::sampling(object = stan_model,data = stan_sim_data,chains = 2,iter = 4000,control=list(adapt_delta=0.95),algorithm=c("Fixed_param"))

#For downstream analysis and plots
ext.fit.simdata <- rstan::extract(fit.simdata)

```

```{r}
#Extract simulated brain mass data
Y_pred<-as.data.frame(ext.fit.simdata$Y_pred)

#names(brain_mass_g_log_mean.sim)<-paste(names(brain_mass_g_log_mean.sim)

test<-data.frame(t(Y_pred[1:100,]))
names(test)<-paste("Sim",1:100,sep="")

#Add to original dataset
reg.trdata$dat<-cbind(reg.trdata$dat,test)
```

Inaccuracy loops for simulated repeated optima
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1/Blouch Testing - SBR1/Functions/repeated_optima_sim.R")

names.traits<-c("X",NA,"regimes")
error.comparison.7reg<-repeated_optima_sim(reg.trdata,n=10,names.traits,head(optima,-1))
error.comparison.7reg
```


Plot Regimes
```{r}
errors.combined<-data.frame(t(cbind(error.comparison.3reg[[3]],error.comparison.5reg[[3]],error.comparison.7reg[[3]])))
errors.combined<-cbind(errors.combined,reps=1:30,regimes=c(rep(3,10),rep(5,10),rep(7,10)))
regimes<-c(3,5,7)
mean.errors.combined<-data.frame(errors.combined%>%group_by(regimes)%>%mutate(mlm.mean=mean(mlm.inaccuracy),npm.mean=mean(npm.inaccuracy)))

mean.errors.combined%>%group_by(regimes)%>%
#errors.combined%>%
  ggplot(aes(x=reps,group=regimes))+
  geom_point(aes(y=mlm.inaccuracy),size=2.0,alpha=0.8)+
  geom_point(aes(y=npm.inaccuracy),shape=21,size=2.0,alpha=0.8)+
  geom_line(aes(x=reps,y=mlm.mean),linetype="solid")+
  geom_line(aes(x=reps,y=npm.mean),linetype="dashed")+
  geom_vline(xintercept=c(10.5,20.5),alpha=0.75,linetype="dotted")+
  ylab("Imprecision") + xlab("Regimes")+
  theme_bw()+
  scale_color_npg()+
  #theme(legend.text)
  scale_x_continuous(breaks=c(5,15,25),labels=regimes)
  #geom_label(label=c(""))


  


```




