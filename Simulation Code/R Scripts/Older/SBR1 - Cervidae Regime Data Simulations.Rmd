---
title: "Blouch SBR1 - Cervidae Tree Fixed Regime Data Simulation"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
Code to simulate fixed regimes on Cervidae Tree


Setup Workspace and load packages
```{r}
rm(list=ls())
library(devtools)
#devtools::install_github("Mark-Grabowski/blouch")

#library(blouch)
#load_all()
# Load necessary packages
library(ape)
library(slouch)
library(rstan)
library(treeplyr)
library(ggplot2)
library(ggsci)
library(bridgesampling)
library(mvSLOUCH)
#For execution on a local, multicore CPU with excess RAM we recommend calling
options(mc.cores = parallel::detectCores())
#options(mc.cores = 8)
rstan_options(auto_write = TRUE)

dotR <- file.path(Sys.getenv("HOME"), ".R")
if (!file.exists(dotR)) dir.create(dotR)
M <- file.path(dotR, "Makevars")
if (!file.exists(M)) file.create(M)
arch <- ifelse(R.version$arch == "aarch64", "arm64", "x86_64")
cat(paste("\nCXX14FLAGS += -O3 -mtune=native -arch", arch, "-ftemplate-depth-256"),
    file = M, sep = "\n", append = FALSE)

```

Data Prep
```{r}
cervid.tree<-read.nexus("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Sharable Data/cervidae_renamed.tre") #Macbook Pro

#cervid.tree<-read.nexus("/Users/markgrabowski/Library/CloudStorage/GoogleDrive-mark.walter.grabowski@gmail.com/Other computers/My MacBook Pro/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Sharable Data/cervidae_renamed.tre") #Mac Studio

cervid.dataset<-read.csv("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Sharable Data/updated_mean_dat_no_OL_MG.csv") #Macbook Pro

#cervid.dataset<-read.csv("/Users/markgrabowski/Library/CloudStorage/GoogleDrive-mark.walter.grabowski@gmail.com/Other computers/My MacBook Pro/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Sharable Data/updated_mean_dat_no_OL_MG.csv") #Mac Studio

#Remove Muntiacus_atherodes, Elaphodus_cephalophus - rudamentary and female Rangifer. 
cervid.dataset<-filter(cervid.dataset,Genus_Species != "Sinomegaloceros_yabei" & ! Genus_Species =="Alces_alces_gigas"  & ! Genus_Species == "Muntiacus_truongsonensis" & ! Genus_Species ==  "Mazama_temama"& ! Genus_Species ==  "Muntiacus_feae" & ! Genus_Species ==  "Muntiacus_atherodes" & ! Genus_Species ==  "Elaphodus_cephalophus")


cervid.trdata <- make.treedata(cervid.tree, cervid.dataset,name_column="Genus_Species")

cervid.trdata<-filter(cervid.trdata,!(is.na(log_ant_vol)) & !(is.na(log_psl)))
cervid.trdata<-mutate(cervid.trdata,mc.log_psl=cervid.trdata$dat$log_psl-(mean(cervid.trdata$dat$log_psl)))

cervid.trdata<-mutate(cervid.trdata,me.log_ant_vol=cervid.trdata$dat$log_vol_var_est/cervid.trdata$dat$n)
cervid.trdata<-mutate(cervid.trdata,me.log_psl=cervid.trdata$dat$log_psl_var_est/cervid.trdata$dat$n)
cervid.trdata<-filter(cervid.trdata,!(is.na(me.log_ant_vol)) & !(is.na(me.log_psl)))


cervid.trdata

```

Rescale Tree to Height =1
```{r}
l.tree<-max(branching.times(cervid.trdata$phy))
cervid.trdata$phy$edge.length<-cervid.trdata$phy$edge.length/l.tree ## rescale tree to height 1
max(branching.times(cervid.trdata$phy))

```


Set regimes - manually - 2 regimes
Locate nodes
```{r}
plot(cervid.trdata$phy)
tiplabels(cex=0.5)
nodelabels(cex=0.5)
#Using node 71
```

Set regimes
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Simulation Code/Functions/set.converge.regimes.R") #Macbook Pro

#source("/Users/markgrabowski/Library/CloudStorage/GoogleDrive-mark.walter.grabowski@gmail.com/Other computers/My MacBook Pro/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Simulation Code/Functions/set.converge.regimes.R") #Mac Studio

shifts<-c(71) #Location of nodes with regime shifts
cervid.2reg.trdata<-set.converge.regimes(cervid.trdata,shifts)


```

Check if manual setting code worked
```{r}
shifts.total<-c(cervid.2reg.trdata$dat$regimes,cervid.2reg.trdata$phy$node.label)
edge.regimes <- factor(shifts.total[cervid.2reg.trdata$phy$edge[,2]])
print(edge.regimes)
#Get ggplot colors used for plot to make on tree
gg_color_hue <- function(n) {
  hues = seq(15, 375, length=n+1)
  hcl(h=hues, l=65, c=100)[1:n]
}

reg.colors<-gg_color_hue(length(unique(cervid.2reg.trdata$dat$regimes)))

print(reg.colors)
plot(cervid.2reg.trdata$phy,edge.color = reg.colors[edge.regimes], edge.width = 1, cex = 0.2)


```



Simulate X and Y variable for Single Covariates - fixed Regimes/direct effect model
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Simulation Code/R Scripts/blouch_simXYOUReg.mvSlouch.setup.R")

slope<-0.25
#hl<-c(0.01,0.05,0.1,0.25,0.5,0.75,1.0,2.0) #For Main Plots
hl<-0.1

vY0 <- 2
vX0 <- 4
#vY0<-0
#vX0<-0
vy<-0.001

stan_sim_data<-blouchsimXYOUReg.setup(cervid.2reg.trdata,num.direct=1,num.random=0,slope,hl,vy,vY0,vX0,reg.values=c(4.0,4.25),reg=TRUE) #Direct effect model

stan_sim_data<-blouchsimXYOUReg.setup(cervid.2reg.trdata,num.direct=1,num.random=0,slope,hl,vy,vY0,vX0,reg.values=c(4.0,4.25),reg=FALSE) #Direct effect model


stan_sim_data<-blouchsimXYOUReg.setup(cervid.2reg.trdata,num.direct=0,num.random=1,slope,hl,vy,vY0,vX0,reg.values=c(4.0,4.25),reg=TRUE) #Adaptive model

stan_sim_data<-blouchsimXYOUReg.setup(cervid.2reg.trdata,num.direct=0,num.random=1,slope,hl,vy,vY0,vX0,reg.values=c(4.0,4.25),reg=FALSE) #Adaptive model

```


Plot simulated relationships
```{r}
df<-data.frame(Y=stan_sim_data$Y,X=stan_sim_data$direct_cov) #Direct effect model
names(df)<-c("Y","X")
ggplot(data=df,aes(x=X,y=Y))+
  geom_point()
lm(Y~X,df)


df<-data.frame(Y=stan_sim_data$Y,X=stan_sim_data$random_cov) #Adaptive Model
names(df)<-c("Y","X")
ggplot(data=df,aes(x=X,y=Y))+
  geom_point()
lm(Y~X,df)

#dotTree(cervid.2reg.trdata$phy,test,length=10,ftype="i",fsize=0.5)

```





Set regimes - manually - 3 regimes
Locate nodes
```{r}
plot(cervid.trdata$phy)
tiplabels(cex=0.5)
nodelabels(cex=0.5)
#Using node 71
```

Set regimes
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Simulation Code/Functions/set.converge.regimes.R") #Macbook Pro

#source("/Users/markgrabowski/Library/CloudStorage/GoogleDrive-mark.walter.grabowski@gmail.com/Other computers/My MacBook Pro/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Simulation Code/Functions/set.converge.regimes.R") #Mac Studio


shifts<-c(71,52) #Location of nodes with regime shifts
cervid.3reg.trdata<-set.converge.regimes(cervid.trdata,shifts)


```

Check if manual setting code worked
```{r}
shifts.total<-c(cervid.3reg.trdata$dat$regimes,cervid.3reg.trdata$phy$node.label)
edge.regimes <- factor(shifts.total[cervid.3reg.trdata$phy$edge[,2]])
print(edge.regimes)
#Get ggplot colors used for plot to make on tree
gg_color_hue <- function(n) {
  hues = seq(15, 375, length=n+1)
  hcl(h=hues, l=65, c=100)[1:n]
}

reg.colors<-gg_color_hue(length(unique(cervid.3reg.trdata$dat$regimes)))

print(reg.colors)
plot(cervid.3reg.trdata$phy,edge.color = reg.colors[edge.regimes], edge.width = 1, cex = 0.2)


```


Simulate X and Y variable for Single Covariates - fixed Regimes/direct effect model
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Simulation Code/R Scripts/blouch_simXYOUReg.mvSlouch.setup.R")

slope<-0.25
#hl<-c(0.01,0.05,0.1,0.25,0.5,0.75,1.0,2.0) #For Main Plots
hl<-0.1

vY0 <- 2
vX0 <- 4
#vY0<-0
#vX0<-0
vy<-0.001

stan_sim_data<-blouchsimXYOUReg.setup(cervid.3reg.trdata,num.direct=1,num.random=0,slope,hl,vy,vY0,vX0,reg.values=c(4.0,4.25,4.5),reg=TRUE)

stan_sim_data<-blouchsimXYOUReg.setup(cervid.3reg.trdata,num.direct=1,num.random=0,slope,hl,vy,vY0,vX0,reg.values=c(4.0,4.25,4.5),reg=FALSE)

stan_sim_data<-blouchsimXYOUReg.setup(cervid.3reg.trdata,num.direct=0,num.random=1,slope,hl,vy,vY0,vX0,reg.values=c(4.0,4.25,4.5),reg=TRUE)

stan_sim_data<-blouchsimXYOUReg.setup(cervid.3reg.trdata,num.direct=0,num.random=1,slope,hl,vy,vY0,vX0,reg.values=c(4.0,4.25,4.5),reg=FALSE)


#Adaptive model
```


Plot simulated relationships
```{r}
df<-data.frame(Y=stan_sim_data$Y,X=stan_sim_data$direct_cov)
names(df)<-c("Y","X")
ggplot(data=df,aes(x=X,y=Y))+
  geom_point()
lm(Y~X,df)

#dotTree(cervid.2reg.trdata$phy,test,length=10,ftype="i",fsize=0.5)

```

Set regimes - manually - 4 regimes
Locate nodes
```{r}
plot(cervid.trdata$phy)
tiplabels(cex=0.5)
nodelabels(cex=0.5)
#Using node 71
```

Set regimes
```{r}
source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Simulation Code/Functions/set.converge.regimes.R") #Macbook Pro

#source("/Users/markgrabowski/Library/CloudStorage/GoogleDrive-mark.walter.grabowski@gmail.com/Other computers/My MacBook Pro/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Simulation Code/Functions/set.converge.regimes.R") #Mac Studio


shifts<-c(71,52,59) #Location of nodes with regime shifts
cervid.4reg.trdata<-set.converge.regimes(cervid.trdata,shifts)


```

Check if manual setting code worked
```{r}
shifts.total<-c(cervid.4reg.trdata$dat$regimes,cervid.4reg.trdata$phy$node.label)
edge.regimes <- factor(shifts.total[cervid.4reg.trdata$phy$edge[,2]])
print(edge.regimes)
#Get ggplot colors used for plot to make on tree
gg_color_hue <- function(n) {
  hues = seq(15, 375, length=n+1)
  hcl(h=hues, l=65, c=100)[1:n]
}

reg.colors<-gg_color_hue(length(unique(cervid.4reg.trdata$dat$regimes)))

print(reg.colors)
plot(cervid.4reg.trdata$phy,edge.color = reg.colors[edge.regimes], edge.width = 1, cex = 0.2)


```

Simulate X and Y variable for Single Covariates - fixed Regimes/direct effect model
```{r}
#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Simulation Code/R Scripts/blouch_simXYOUReg.setup.R") #Macbook Pro

source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Simulation Code/R Scripts/blouch_simXYOUReg.mvSlouch.setup.R")
#source("/Users/markgrabowski/Library/CloudStorage/GoogleDrive-mark.walter.grabowski@gmail.com/Other computers/My MacBook Pro/Documents/Academic/Research/Current Projects/Blouch project/R1 blouch-testing branch/Simulation Code/R Scripts/blouch_simXYOUReg.setup.R") #Mac Studio

slope<-0.25
#hl<-c(0.01,0.05,0.1,0.25,0.5,0.75,1.0,2.0) #For Main Plots
hl<-0.1

#vY0 <- 2
#vX0 <- 4
vY0<-0
vX0<-0
vy<-0.001

stan_sim_data<-blouchsimXYOUReg.setup(cervid.4reg.trdata,num.direct=1,num.random=0,slope,hl,vy,vY0,vX0,reg.values=c(4.0,4.25,4.5,4.75),direct=0) #Direct effect model

stan_sim_data<-blouchsimXYOUReg.setup(cervid.4reg.trdata,num.direct=1,num.random=0,slope,hl,vy,vY0,vX0,reg.values=c(4.0,4.25,4.5,4.75)) #Adaptive model
```


Plot simulated relationships
```{r}
df<-data.frame(Y=stan_sim_data$Y,X=stan_sim_data$direct_cov)
names(df)<-c("Y","X")
ggplot(data=df,aes(x=X,y=Y))+
  geom_point()
lm(Y~X,df)

#dotTree(cervid.2reg.trdata$phy,test,length=10,ftype="i",fsize=0.5)

```


