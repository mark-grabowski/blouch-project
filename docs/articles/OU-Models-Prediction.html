<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="blouch">
<title>OU-Models-Prediction • blouch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="OU-Models-Prediction">
<meta property="og:description" content="blouch">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script>if(!sessionStorage.getItem("_swa")&&document.referrer.indexOf(location.protocol+"//"+location.host)!== 0){fetch("https://counter.dev/track?"+new URLSearchParams({referrer:document.referrer,screen:screen.width+"x"+screen.height,user:"mark-grabowski",utcoffset:"0"}))};sessionStorage.setItem("_swa","1");</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-default navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">blouch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-2">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/index.html">Getting Started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/OU-Models.html">OU-Models</a>
    <a class="dropdown-item" href="../articles/OU-Models-Prediction.html">OU Models with Prediction</a>
    <a class="dropdown-item" href="../articles/faq.html">FAQ</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="https://github.com/mark-grabowski/blouch">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://mark-grabowski.github.io/blouch/">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">

<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>OU-Models-Prediction</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mark-grabowski/blouch/blob/HEAD/vignettes/OU-Models-Prediction.Rmd"><code>vignettes/OU-Models-Prediction.Rmd</code></a></small>
      <div class="d-none name"><code>OU-Models-Prediction.Rmd</code></div>
    </div>

    
    
<div class="section level1">
<h1 id="ou-models-with-prediction">OU Models with Prediction<a class="anchor" aria-label="anchor" href="#ou-models-with-prediction"></a>
</h1>
<p>This vignette walks you through the basic steps of running an analysis in Blouch including prediction of unknown/fossil values.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>Here we load the R packages used to setup the data for blouch, make figures post-analysis, etc.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: usethis</span>
<span class="co">#devtools::install_github("Mark-Grabowski/blouch")</span>
<span class="co">#library(blouch)</span>

<span class="co">#devtools::install_github("Mark-Grabowski/blouch"</span>
<span class="co">#                         ,ref="master"</span>
<span class="co">#                         ,auth_token = "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"</span>
<span class="co">#                         )</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mark-grabowski/blouch">blouch</a></span><span class="op">)</span>
<span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Loading <span style="color: #0000BB;">blouch</span></span>
<span class="co"># Load necessary packages</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/" class="external-link">ape</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/kopperud/slouch" class="external-link">slouch</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: StanHeaders</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; rstan version 2.26.4 (Stan version 2.26.1)</span>
<span class="co">#&gt; For execution on a local, multicore CPU with excess RAM we recommend calling</span>
<span class="co">#&gt; options(mc.cores = parallel::detectCores()).</span>
<span class="co">#&gt; To avoid recompilation of unchanged Stan programs, we recommend calling</span>
<span class="co">#&gt; rstan_options(auto_write = TRUE)</span>
<span class="co">#&gt; For within-chain threading using `reduce_sum()` or `map_rect()` Stan functions,</span>
<span class="co">#&gt; change `threads_per_chain` option:</span>
<span class="co">#&gt; rstan_options(threads_per_chain = 1)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/uyedaj/treeplyr" class="external-link">treeplyr</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: dplyr</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'treeplyr'</span>
<span class="co">#&gt; The following object is masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     reorder</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/quentingronau/bridgesampling" class="external-link">bridgesampling</a></span><span class="op">)</span>

<span class="co">#For execution on a local, multicore CPU with excess RAM we recommend calling</span>
<span class="co">#options(mc.cores = parallel::detectCores())</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://mc-stan.org/rstan/reference/rstan_options.html" class="external-link">rstan_options</a></span><span class="op">(</span>auto_write <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co">#remotes::install_github("stan-dev/rstan", ref = "develop", subdir = "rstan/rstan")</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="scale-tree">Scale Tree<a class="anchor" aria-label="anchor" href="#scale-tree"></a>
</h2>
<p>For the purposes of illustrating the software, we will use a dataset of ruminant brain and body sizes bundled with the Slouch package (Kopperud et al. 2020) and a corresponding phylogenetic tree (Toljagić et al. 2017). First, we will organize the brain and body data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Load the phylogenetic tree with annotation data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">artiodactyla</span><span class="op">)</span>
<span class="va">phy</span> <span class="op">&lt;-</span> <span class="va">artiodactyla</span>

<span class="co">## Load the neocortex dataset</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">neocortex</span><span class="op">)</span>

<span class="co">## Plot the tree</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/ladderize.html" class="external-link">ladderize</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></code></pre></div>
<p><img src="OU-Models-Prediction_files/figure-html/unnamed-chunk-2-1.png" width="700"> ## Data Prep We will use the treeplyr function make.treedata to combine the data and tree based on the “species” column, which has the taxa names. See <a href="https://github.com/uyedaj/treeplyr" class="external-link uri">https://github.com/uyedaj/treeplyr</a> for more on this package.Then we will finlter the data so only individuals with both brain and body size, as well as the variance in brain and body size are included. Variance in these traits is considered measurement error, estimation error in species averages.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ruminant.trdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>, <span class="va">neocortex</span>,name_column<span class="op">=</span><span class="st">"species"</span><span class="op">)</span>

<span class="va">ruminant.trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ruminant.trdata</span>,<span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">brain_mass_g_log_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">body_mass_g_log_mean</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">ruminant.trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ruminant.trdata</span>,<span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">brain_se_squared</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">body_se_squared</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">ruminant.trdata</span> <span class="co">#Full dataset</span>
<span class="co">#&gt; $phy </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Phylogenetic tree with 43 tips and 42 internal nodes.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Tip labels:</span>
<span class="co">#&gt;   Antilocapra_americana, Addax_nasomaculatus, Aepyceros_melampus, Alcelaphus_buselaphus_buselaphus, Antidorcas_marsupialis, Antilope_cervicapra, ...</span>
<span class="co">#&gt; Node labels:</span>
<span class="co">#&gt;   MF, MF, MF, MF, MF, MF, ...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Rooted; includes branch lengths.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $dat </span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 43 × 10</span></span>
<span class="co">#&gt;    brain_mass_g_log_… brain_se_squared n_brain body_mass_g_log_… body_se_squared</span>
<span class="co">#&gt;                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>               4.80         0.010<span style="text-decoration: underline;">9</span>         1             11.0          0.042<span style="text-decoration: underline;">6</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>               5.30         0.005<span style="text-decoration: underline;">47</span>        2             11.6          0.021<span style="text-decoration: underline;">3</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>               5.15         0.000<span style="text-decoration: underline;">995</span>      11             10.9          0.003<span style="text-decoration: underline;">87</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>               5.69         0.002<span style="text-decoration: underline;">19</span>        5             11.9          0.008<span style="text-decoration: underline;">52</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>               4.91         0.000<span style="text-decoration: underline;">842</span>      13             10.5          0.003<span style="text-decoration: underline;">28</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>               4.77         0.010<span style="text-decoration: underline;">9</span>         1             10.4          0.042<span style="text-decoration: underline;">6</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>               4.42         0.010<span style="text-decoration: underline;">9</span>         1              9.43         0.042<span style="text-decoration: underline;">6</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>               4.42         0.003<span style="text-decoration: underline;">65</span>        3              9.58         0.021<span style="text-decoration: underline;">3</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>               3.52         0.001<span style="text-decoration: underline;">37</span>        8              8.46         0.005<span style="text-decoration: underline;">33</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span>               5.72         0.010<span style="text-decoration: underline;">9</span>         1             11.9          0.042<span style="text-decoration: underline;">6</span> </span>
<span class="co">#&gt; <span style="color: #949494;"># … with 33 more rows, and 5 more variables: n_body &lt;int&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   neocortex_area_mm2_log_mean &lt;dbl&gt;, neocortex_se_squared &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   n_neocortex &lt;int&gt;, diet &lt;fct&gt;</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="classical-regression">Classical Regression<a class="anchor" aria-label="anchor" href="#classical-regression"></a>
</h2>
<p>Here we will assign one taxa as the fossil species to be predicted, and use Classical Regression to predict an unknown value based on the combination of phylogeny and allometry. Here we are regression Y - brain size on X body size, and then predicting a fossil X (body size) based on its Y (brain size). Finally we mean scale the X data (here body mass) so that the average across species is 0.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Status</span><span class="op">&lt;-</span><span class="st">"Extant"</span> <span class="co">#Label all species as extant</span>
<span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Status</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"Extinct"</span> <span class="co">#Make one extinct</span>
<span class="va">n.fos</span><span class="op">&lt;-</span><span class="fl">1</span>

<span class="co">#Classical Regression - Predicting X using regression of Y on X</span>
<span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g_log_mean</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">&lt;-</span><span class="fl">0</span> <span class="co">#Assign this species fake body mass</span>
<span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">body_se_squared</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">&lt;-</span><span class="fl">0</span> <span class="co">#And ME</span>

<span class="va">ruminant.extant.trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ruminant.trdata</span>, <span class="op">(</span><span class="va">Status</span> <span class="op">==</span> <span class="st">"Extant"</span><span class="op">)</span><span class="op">)</span> <span class="co">#Only non-fossil species</span>

<span class="co">#Mean Standardized based on whether fossil is included in dataset</span>

<span class="co">#Classical regression - predicting brain size - X</span>
<span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">bodycentered</span><span class="op">&lt;-</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g_log_mean</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g_log_mean</span><span class="op">[</span><span class="op">-</span><span class="va">n.fos</span><span class="op">]</span><span class="op">)</span>
<span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">bodycentered</span><span class="op">&lt;-</span><span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g_log_mean</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g_log_mean</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="rescale-tree">Rescale Tree<a class="anchor" aria-label="anchor" href="#rescale-tree"></a>
</h2>
<p>Next, we rescale Tree to Height = 1</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span>
<span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> <span class="co">## rescale tree to height 1</span>
<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 1</span>

<span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span>
<span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> <span class="co">## rescale tree to height 1</span>
<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 1</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="running-blouch-data-setup-function---1st-trait-is-adapting-to-2">Running Blouch Data Setup Function - 1st trait is adapting to 2<a class="anchor" aria-label="anchor" href="#running-blouch-data-setup-function---1st-trait-is-adapting-to-2"></a>
</h2>
<p>Here we are finally setting up our dataset to run in Blouch, using the blouchOUPredict.setup.v1() function. This function takes out data formatted by treeplyr, and the names of our traits of interest in the order shown. The list produced by this function has data formatted to run both the direct effect (constraint) models and adaptative models. See Grabowski et al. (2016) for more on both of these models.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#names.traits&lt;-c("brain_mass_g_log_mean","bodycentered","NA","NA") #With ME</span>
<span class="va">names.traits</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"brain_mass_g_log_mean"</span>,<span class="st">"bodycentered"</span>,<span class="st">"brain_se_squared"</span>,<span class="st">"body_se_squared"</span><span class="op">)</span> <span class="co">#With ME</span>

<span class="co">#Data must be logged before entry into blouch.setup</span>
<span class="co">#names.traits = c(response, predictor, me.response, me.predictor) - classical = 0 for inverse regression</span>
<span class="va">stan_data</span><span class="op">&lt;-</span><span class="fu">blouchOUPredict.setup.v1</span><span class="op">(</span><span class="va">ruminant.extant.trdata</span>,<span class="va">ruminant.trdata</span>,<span class="va">names.traits</span>,classical<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; [1] "Fossil Species # 1"</span>

<span class="va">stan_constraint_data</span><span class="op">&lt;-</span><span class="va">stan_data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="va">stan_adaptive_data</span><span class="op">&lt;-</span><span class="va">stan_data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="explore-priors-slope-and-intercept">Explore Priors: Slope and intercept<a class="anchor" aria-label="anchor" href="#explore-priors-slope-and-intercept"></a>
</h2>
<p>Priors must be set manually in the Stan Blouch code (e.g. blouchOUPredict_v1.stan), but we use the same priors for this analysis as in the OU-Models vignette. Go back and look at that vignette if you need to explore the effect of your priors - do not use the default values.</p>
</div>
<div class="section level2">
<h2 id="direct-effect-model-for-prediction">Direct EFfect Model for Prediction<a class="anchor" aria-label="anchor" href="#direct-effect-model-for-prediction"></a>
</h2>
<p>Now that we have formatted our data and supplied reasonable priors for the various distributions, we can now run Blouch.</p>
<p>Blouch implements the model of constrained evolution (Hansen &amp; Bartoszek, 2012) known as the direct effect model, previously implemented in Grabowski et al. (2016), which can be used to test for allometric constraints. We will be using this model to predict unknown values as assuming an allometric relationship may be more valid in prediction than an adaptive relationship.</p>
<p>Here we run this model using 2 chains and 4000 iterations per chain. This code follows standard Stan/Rstan code.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit.fos.direct</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOUPredict_v1</span>,data <span class="op">=</span> <span class="va">stan_constraint_data</span>,chains <span class="op">=</span> <span class="fl">2</span>,iter <span class="op">=</span> <span class="fl">4000</span>,control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta<span class="op">=</span><span class="fl">0.95</span><span class="op">)</span>,save_warmup<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Stan prints out a lot of info, so lets just look at the parameter estimates here and store the most important stuff for later.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.fos.direct</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>,<span class="st">"hl"</span>,<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"r_squared"</span>,<span class="st">"sigma2_y"</span>,<span class="st">"RMSE"</span>,<span class="st">"RMSE_mu"</span>,<span class="st">"X_pred_fos_means"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Inference for Stan model: blouchOUPredict_v1.</span>
<span class="co">#&gt; 2 chains, each with iter=4000; warmup=2000; thin=1; </span>
<span class="co">#&gt; post-warmup draws per chain=2000, total post-warmup draws=4000.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                      mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat</span>
<span class="co">#&gt; a                    6.05    0.36 9.60  0.43  1.44  3.02  6.56 31.15   700    1</span>
<span class="co">#&gt; hl                   0.39    0.01 0.50  0.02  0.11  0.23  0.48  1.62  1605    1</span>
<span class="co">#&gt; alpha                5.07    0.00 0.04  5.00  5.04  5.06  5.09  5.15  1726    1</span>
<span class="co">#&gt; beta[1]              0.57    0.00 0.02  0.53  0.56  0.57  0.58  0.61  2387    1</span>
<span class="co">#&gt; r_squared            0.96    0.00 0.00  0.95  0.96  0.96  0.97  0.97  1210    1</span>
<span class="co">#&gt; sigma2_y             0.16    0.01 0.24  0.02  0.04  0.08  0.17  0.85   560    1</span>
<span class="co">#&gt; RMSE                 0.29    0.00 0.03  0.25  0.28  0.29  0.31  0.35  3011    1</span>
<span class="co">#&gt; RMSE_mu              0.27    0.00 0.02  0.26  0.26  0.26  0.27  0.32  1135    1</span>
<span class="co">#&gt; X_pred_fos_means[1] -0.47    0.00 0.18 -0.82 -0.59 -0.48 -0.36 -0.13  3538    1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Wed Dec  8 22:28:50 2021.</span>
<span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span>
<span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span>
<span class="co">#&gt; convergence, Rhat=1).</span>

<span class="va">posterior.fit.fos.direct</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.fos.direct</span><span class="op">)</span></code></pre></div>
<p>Blouch follows the same format of parameter estimate presentation as Slouch - see Hansen et al. (2008), Grabowski et al. (2016), and Kopperud et al. (2020) for more explanation.</p>
</div>
<div class="section level2">
<h2 id="trace-and-density-plots-for-estimated-parameters">Trace and Density Plots for estimated parameters<a class="anchor" aria-label="anchor" href="#trace-and-density-plots-for-estimated-parameters"></a>
</h2>
<p>We can look at how our procedures using the standard trace and density plots from Rstan</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
  
<span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">fit.fos.direct</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>,<span class="st">"hl"</span>,<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"vy"</span>,<span class="st">"sigma2_y"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="OU-Models-Prediction_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_plot.html" class="external-link">stan_dens</a></span><span class="op">(</span><span class="va">fit.fos.direct</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>,<span class="st">"hl"</span>,<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"vy"</span>,<span class="st">"sigma2_y"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="OU-Models-Prediction_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#3 X 8</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plots">Plots<a class="anchor" aria-label="anchor" href="#plots"></a>
</h2>
<p>Let’s make some plots of our results</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nanx.me/ggsci/" class="external-link">ggsci</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://plotly-r.com" class="external-link">plotly</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'plotly'</span>
<span class="co">#&gt; The following object is masked from 'package:ggplot2':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     last_plot</span>
<span class="co">#&gt; The following object is masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter</span>
<span class="co">#&gt; The following object is masked from 'package:graphics':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     layout</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-setup-for-plots">Data Setup for Plots<a class="anchor" aria-label="anchor" href="#data-setup-for-plots"></a>
</h2>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">old.par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">old.par</span><span class="op">)</span>

<span class="va">fos.index</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Status</span><span class="op">==</span><span class="st">"Extinct"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Fossil Species #"</span>,<span class="va">fos.index</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "Fossil Species # 1"</span>
<span class="va">extant.index</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Status</span><span class="op">==</span><span class="st">"Extant"</span><span class="op">)</span>

<span class="va">body.predictions</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">posterior.fit.fos.direct</span><span class="op">$</span><span class="va">X_pred_fos_means</span>,<span class="fl">2</span>,<span class="va">mean</span><span class="op">)</span>
<span class="va">body.predictions.extant</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">posterior.fit.fos.direct</span><span class="op">$</span><span class="va">X_pred_extant_means</span>,<span class="fl">2</span>,<span class="va">mean</span><span class="op">)</span>

<span class="va">extant.data</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Genus_Species <span class="op">=</span> <span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">[</span><span class="op">-</span><span class="va">fos.index</span><span class="op">]</span>,log_brain <span class="op">=</span> <span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">brain_mass_g_log_mean</span><span class="op">[</span><span class="op">-</span><span class="va">fos.index</span><span class="op">]</span>,log_body_pred <span class="op">=</span> <span class="va">body.predictions.extant</span>,log_body <span class="op">=</span> <span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">bodycentered</span><span class="op">[</span><span class="op">-</span><span class="va">fos.index</span><span class="op">]</span>,Status<span class="op">=</span><span class="st">"Extant"</span><span class="op">)</span>

<span class="va">fos.predictions</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Genus_Species <span class="op">=</span> <span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">[</span><span class="va">fos.index</span><span class="op">]</span>,log_brain <span class="op">=</span> <span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">brain_mass_g_log_mean</span><span class="op">[</span><span class="va">fos.index</span><span class="op">]</span>, log_body_pred <span class="op">=</span> <span class="va">body.predictions</span><span class="op">[</span><span class="va">fos.index</span><span class="op">]</span>,log_body<span class="op">=</span><span class="cn">NA</span>,Status<span class="op">=</span><span class="st">"Extinct"</span><span class="op">)</span>
         
<span class="va">merged.data</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">extant.data</span>,<span class="va">fos.predictions</span><span class="op">)</span>                   </code></pre></div>
</div>
<div class="section level2">
<h2 id="make-plots">Make Plots<a class="anchor" aria-label="anchor" href="#make-plots"></a>
</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">brbo.plot</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">merged.data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">log_brain</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">log_body_pred</span>,color<span class="op">=</span><span class="va">Status</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">2.5</span>,alpha<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span><span class="op">+</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">log_body</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">2.0</span>,alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span><span class="op">+</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">posterior.fit.fos.direct</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span>,slope <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">posterior.fit.fos.direct</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span>,lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">+</span> <span class="co">#5X5</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"log Brain Mass (g)"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"log Body Mass (g)"</span><span class="op">)</span>

<span class="co">#+theme(legend. position = "none")</span>
<span class="va">brbo.plot</span><span class="op">+</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_aaas.html" class="external-link">scale_color_aaas</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 1 rows containing missing values (geom_point).</span></code></pre></div>
<p><img src="OU-Models-Prediction_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Export 5.25X5 PDF</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="inverse-regression">Inverse Regression<a class="anchor" aria-label="anchor" href="#inverse-regression"></a>
</h2>
<p>Here we will assign one taxa as the fossil species to be predicted, and use Inverse Regression to predict an unknown value based on the combination of phylogeny and allometry. Here we are regression Y - brain size on X body size, and then predicting a fossil Y (brain mass) based on its X (body mass). Finally we mean scale the X data (here body mass) so that the average across species is 0.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ruminant.trdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>, <span class="va">neocortex</span>,name_column<span class="op">=</span><span class="st">"species"</span><span class="op">)</span>

<span class="va">ruminant.trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ruminant.trdata</span>,<span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">brain_mass_g_log_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">body_mass_g_log_mean</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">ruminant.trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ruminant.trdata</span>,<span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">brain_se_squared</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">body_se_squared</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">ruminant.trdata</span> <span class="co">#Full dataset</span>
<span class="co">#&gt; $phy </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Phylogenetic tree with 43 tips and 42 internal nodes.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Tip labels:</span>
<span class="co">#&gt;   Antilocapra_americana, Addax_nasomaculatus, Aepyceros_melampus, Alcelaphus_buselaphus_buselaphus, Antidorcas_marsupialis, Antilope_cervicapra, ...</span>
<span class="co">#&gt; Node labels:</span>
<span class="co">#&gt;   MF, MF, MF, MF, MF, MF, ...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Rooted; includes branch lengths.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $dat </span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 43 × 10</span></span>
<span class="co">#&gt;    brain_mass_g_log_… brain_se_squared n_brain body_mass_g_log_… body_se_squared</span>
<span class="co">#&gt;                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>               4.80         0.010<span style="text-decoration: underline;">9</span>         1             11.0          0.042<span style="text-decoration: underline;">6</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>               5.30         0.005<span style="text-decoration: underline;">47</span>        2             11.6          0.021<span style="text-decoration: underline;">3</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>               5.15         0.000<span style="text-decoration: underline;">995</span>      11             10.9          0.003<span style="text-decoration: underline;">87</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>               5.69         0.002<span style="text-decoration: underline;">19</span>        5             11.9          0.008<span style="text-decoration: underline;">52</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>               4.91         0.000<span style="text-decoration: underline;">842</span>      13             10.5          0.003<span style="text-decoration: underline;">28</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>               4.77         0.010<span style="text-decoration: underline;">9</span>         1             10.4          0.042<span style="text-decoration: underline;">6</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>               4.42         0.010<span style="text-decoration: underline;">9</span>         1              9.43         0.042<span style="text-decoration: underline;">6</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>               4.42         0.003<span style="text-decoration: underline;">65</span>        3              9.58         0.021<span style="text-decoration: underline;">3</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>               3.52         0.001<span style="text-decoration: underline;">37</span>        8              8.46         0.005<span style="text-decoration: underline;">33</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span>               5.72         0.010<span style="text-decoration: underline;">9</span>         1             11.9          0.042<span style="text-decoration: underline;">6</span> </span>
<span class="co">#&gt; <span style="color: #949494;"># … with 33 more rows, and 5 more variables: n_body &lt;int&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   neocortex_area_mm2_log_mean &lt;dbl&gt;, neocortex_se_squared &lt;dbl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   n_neocortex &lt;int&gt;, diet &lt;fct&gt;</span></span>

<span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Status</span><span class="op">&lt;-</span><span class="st">"Extant"</span> <span class="co">#Label all species as extant</span>
<span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Status</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"Extinct"</span> <span class="co">#Make one extinct</span>
<span class="va">n.fos</span><span class="op">&lt;-</span><span class="fl">1</span>

<span class="co">#Inverse Regression - Predicting Y using regression of Y on X</span>
<span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">brain_mass_g_log_mean</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">&lt;-</span><span class="fl">0</span> <span class="co">#Assign this species fake body mass</span>
<span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">brain_se_squared</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">&lt;-</span><span class="fl">0</span> <span class="co">#And ME</span>

<span class="va">ruminant.extant.trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ruminant.trdata</span>, <span class="op">(</span><span class="va">Status</span> <span class="op">==</span> <span class="st">"Extant"</span><span class="op">)</span><span class="op">)</span> <span class="co">#Only non-fossil species</span>

<span class="co">#Mean Standardized based on whether fossil is included in dataset</span>
<span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">bodycentered</span><span class="op">&lt;-</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g_log_mean</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g_log_mean</span><span class="op">[</span><span class="op">-</span><span class="va">n.fos</span><span class="op">]</span><span class="op">)</span>
<span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">bodycentered</span><span class="op">&lt;-</span><span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g_log_mean</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g_log_mean</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="rescale-tree-1">Rescale Tree<a class="anchor" aria-label="anchor" href="#rescale-tree-1"></a>
</h2>
<p>Next, we rescale Tree to Height = 1</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span>
<span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> <span class="co">## rescale tree to height 1</span>
<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 1</span>

<span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span>
<span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> <span class="co">## rescale tree to height 1</span>
<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">ruminant.extant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 1</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="running-blouch-data-setup-function---1st-trait-is-adapting-to-2-1">Running Blouch Data Setup Function - 1st trait is adapting to 2<a class="anchor" aria-label="anchor" href="#running-blouch-data-setup-function---1st-trait-is-adapting-to-2-1"></a>
</h2>
<p>Here we are finally setting up our dataset to run in Blouch, using the blouchOUPredict.setup.v1() function. This function takes out data formatted by treeplyr, and the names of our traits of interest in the order shown. The list produced by this function has data formatted to run both the direct effect (constraint) models and adaptative models. See Grabowski et al. (2016) for more on both of these models.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">#names.traits&lt;-c("brain_mass_g_log_mean","bodycentered","NA","NA") #With ME</span>
<span class="va">names.traits</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"brain_mass_g_log_mean"</span>,<span class="st">"bodycentered"</span>,<span class="st">"brain_se_squared"</span>,<span class="st">"body_se_squared"</span><span class="op">)</span> <span class="co">#With ME</span>

<span class="co">#Data must be logged before entry into blouch.setup</span>
<span class="co">#names.traits = c(response, predictor, me.response, me.predictor) - classical = 0 for inverse regression</span>
<span class="va">stan_data</span><span class="op">&lt;-</span><span class="fu">blouchOUPredict.setup.v1</span><span class="op">(</span><span class="va">ruminant.extant.trdata</span>,<span class="va">ruminant.trdata</span>,<span class="va">names.traits</span>,classical<span class="op">=</span><span class="fl">0</span><span class="op">)</span>
<span class="co">#&gt; [1] "Fossil Species # 1"</span>

<span class="va">stan_constraint_data</span><span class="op">&lt;-</span><span class="va">stan_data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="va">stan_adaptive_data</span><span class="op">&lt;-</span><span class="va">stan_data</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="direct-effect-model-for-prediction-1">Direct EFfect Model for Prediction<a class="anchor" aria-label="anchor" href="#direct-effect-model-for-prediction-1"></a>
</h2>
<p>Now that we have formatted our data and supplied reasonable priors for the various distributions, we can now run Blouch.</p>
<p>Blouch implements the model of constrained evolution (Hansen &amp; Bartoszek, 2012) known as the direct effect model, previously implemented in Grabowski et al. (2016), which can be used to test for allometric constraints. We will be using this model to predict unknown values as assuming an allometric relationship may be more valid in prediction than an adaptive relationship.</p>
<p>Here we run this model using 2 chains and 4000 iterations per chain. This code follows standard Stan/Rstan code.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit.fos.direct</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOUPredict_v1</span>,data <span class="op">=</span> <span class="va">stan_constraint_data</span>,chains <span class="op">=</span> <span class="fl">2</span>,iter <span class="op">=</span> <span class="fl">4000</span>,control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta<span class="op">=</span><span class="fl">0.95</span><span class="op">)</span>,save_warmup<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Stan prints out a lot of info, so lets just look at the parameter estimates here and store the most important stuff for later.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.fos.direct</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>,<span class="st">"hl"</span>,<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"r_squared"</span>,<span class="st">"sigma2_y"</span>,<span class="st">"RMSE"</span>,<span class="st">"RMSE_mu"</span>,<span class="st">"Y_pred_fos_means"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Inference for Stan model: blouchOUPredict_v1.</span>
<span class="co">#&gt; 2 chains, each with iter=4000; warmup=2000; thin=1; </span>
<span class="co">#&gt; post-warmup draws per chain=2000, total post-warmup draws=4000.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                     mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span>
<span class="co">#&gt; a                   5.75    0.32 9.29 0.38 1.32 2.72 6.29 29.68   830    1</span>
<span class="co">#&gt; hl                  0.42    0.01 0.55 0.02 0.11 0.25 0.53  1.81  1611    1</span>
<span class="co">#&gt; alpha               5.07    0.00 0.04 4.99 5.04 5.06 5.09  5.15  1706    1</span>
<span class="co">#&gt; beta[1]             0.57    0.00 0.02 0.53 0.55 0.57 0.58  0.61  2212    1</span>
<span class="co">#&gt; r_squared           0.96    0.00 0.00 0.95 0.96 0.96 0.97  0.97  1065    1</span>
<span class="co">#&gt; sigma2_y            0.15    0.01 0.23 0.02 0.04 0.07 0.16  0.77   804    1</span>
<span class="co">#&gt; RMSE                0.21    0.00 0.02 0.17 0.20 0.21 0.23  0.26  3496    1</span>
<span class="co">#&gt; RMSE_mu             0.15    0.00 0.01 0.15 0.15 0.15 0.16  0.18   960    1</span>
<span class="co">#&gt; Y_pred_fos_means[1] 5.09    0.00 0.13 4.84 5.01 5.09 5.17  5.34  3436    1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Wed Dec  8 22:34:17 2021.</span>
<span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span>
<span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span>
<span class="co">#&gt; convergence, Rhat=1).</span>

<span class="va">posterior.fit.fos.direct</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.fos.direct</span><span class="op">)</span></code></pre></div>
<p>Blouch follows the same format of parameter estimate presentation as Slouch - see Hansen et al. (2008), Grabowski et al. (2016), and Kopperud et al. (2020) for more explanation.</p>
</div>
<div class="section level2">
<h2 id="trace-and-density-plots-for-estimated-parameters-1">Trace and Density Plots for estimated parameters<a class="anchor" aria-label="anchor" href="#trace-and-density-plots-for-estimated-parameters-1"></a>
</h2>
<p>We can look at how our procedures using the standard trace and density plots from Rstan</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
  
<span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">fit.fos.direct</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>,<span class="st">"hl"</span>,<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"vy"</span>,<span class="st">"sigma2_y"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="OU-Models-Prediction_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_plot.html" class="external-link">stan_dens</a></span><span class="op">(</span><span class="va">fit.fos.direct</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>,<span class="st">"hl"</span>,<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"vy"</span>,<span class="st">"sigma2_y"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="OU-Models-Prediction_files/figure-html/unnamed-chunk-18-2.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#3 X 8</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="inverse-regression-plots">Inverse Regression Plots<a class="anchor" aria-label="anchor" href="#inverse-regression-plots"></a>
</h2>
<p>Let’s make some plots of our results</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nanx.me/ggsci/" class="external-link">ggsci</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="co">#library(plotly)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-setup-for-plots-1">Data setup for plots<a class="anchor" aria-label="anchor" href="#data-setup-for-plots-1"></a>
</h2>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">old.par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">old.par</span><span class="op">)</span>

<span class="va">fos.index</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Status</span><span class="op">==</span><span class="st">"Extinct"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Fossil Species #"</span>,<span class="va">fos.index</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "Fossil Species # 1"</span>
<span class="va">extant.index</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Status</span><span class="op">==</span><span class="st">"Extant"</span><span class="op">)</span>

<span class="va">brain.predictions</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">posterior.fit.fos.direct</span><span class="op">$</span><span class="va">Y_pred_fos_means</span>,<span class="fl">2</span>,<span class="va">mean</span><span class="op">)</span>
<span class="va">brain.predictions.extant</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">posterior.fit.fos.direct</span><span class="op">$</span><span class="va">Y_pred_extant_means</span>,<span class="fl">2</span>,<span class="va">mean</span><span class="op">)</span>

<span class="va">extant.data</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Genus_Species <span class="op">=</span> <span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">[</span><span class="op">-</span><span class="va">fos.index</span><span class="op">]</span>,log_brain <span class="op">=</span> <span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">brain_mass_g_log_mean</span><span class="op">[</span><span class="op">-</span><span class="va">fos.index</span><span class="op">]</span>,log_brain_pred <span class="op">=</span> <span class="va">brain.predictions.extant</span>,log_body <span class="op">=</span> <span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">bodycentered</span><span class="op">[</span><span class="op">-</span><span class="va">fos.index</span><span class="op">]</span>,Status<span class="op">=</span><span class="st">"Extant"</span><span class="op">)</span>

<span class="va">fos.predictions</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Genus_Species <span class="op">=</span> <span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">[</span><span class="va">fos.index</span><span class="op">]</span>, log_brain<span class="op">=</span> <span class="cn">NA</span>, log_brain_pred <span class="op">=</span> <span class="va">brain.predictions</span><span class="op">[</span><span class="va">fos.index</span><span class="op">]</span>,log_body<span class="op">=</span><span class="va">ruminant.trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">bodycentered</span><span class="op">[</span><span class="va">fos.index</span><span class="op">]</span>,Status<span class="op">=</span><span class="st">"Extinct"</span><span class="op">)</span>
         
<span class="va">merged.data</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">extant.data</span>,<span class="va">fos.predictions</span><span class="op">)</span>                   </code></pre></div>
</div>
<div class="section level2">
<h2 id="make-plots-1">Make Plots<a class="anchor" aria-label="anchor" href="#make-plots-1"></a>
</h2>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">brbo.plot</span><span class="op">&lt;-</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">merged.data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">log_body</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">log_brain</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">2.0</span>,alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span><span class="op">+</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">log_brain_pred</span>,color<span class="op">=</span><span class="va">Status</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">2.5</span>,alpha<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span><span class="op">+</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">posterior.fit.fos.direct</span><span class="op">$</span><span class="va">alpha</span><span class="op">)</span>,slope <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">posterior.fit.fos.direct</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span>,lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">+</span> <span class="co">#5X5</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"log Body Mass (g)"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"log Brain Mass (g)"</span><span class="op">)</span>

<span class="co">#+theme(legend. position = "none")</span>
<span class="va">brbo.plot</span><span class="op">+</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_aaas.html" class="external-link">scale_color_aaas</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 1 rows containing missing values (geom_point).</span></code></pre></div>
<p><img src="OU-Models-Prediction_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Export 5.25X5 PDF</span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mark Grabowski.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
